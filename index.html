<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Patrimônio — Diego & Dinha</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Outfit:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

<!-- Firebase -->
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
  import { getDatabase, ref, onValue, push, set, remove, get } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

  // ── FIREBASE CONFIG (replace with yours after setup) ──
  const firebaseConfig = {
    apiKey: "FIREBASE_API_KEY",
    authDomain: "FIREBASE_AUTH_DOMAIN",
    databaseURL: "FIREBASE_DATABASE_URL",
    projectId: "FIREBASE_PROJECT_ID",
    storageBucket: "FIREBASE_STORAGE_BUCKET",
    messagingSenderId: "FIREBASE_MESSAGING_SENDER_ID",
    appId: "FIREBASE_APP_ID"
  };

  let app, db, useFirebase = false;

  try {
    if (!firebaseConfig.apiKey.includes('FIREBASE')) {
      app = initializeApp(firebaseConfig);
      db = getDatabase(app);
      useFirebase = true;
      document.getElementById('sync-status').textContent = 'Sincronizado';
      document.getElementById('sync-dot').style.background = 'var(--green)';
    }
  } catch(e) {}

  window._firebase = { db, ref, onValue, push, set, remove, get, useFirebase };

  if (useFirebase) {
    // Real-time listeners
    const tables = ['lancamentos','dividas','metas','banks','investimentos','empadas','laromme','alertas'];
    tables.forEach(t => {
      onValue(ref(db, `patrimonio/${t}`), snap => {
        const data = snap.val();
        S[t] = data ? Object.entries(data).map(([k,v]) => ({...v, _key: k})) : [];
        renderAll();
        updateDashboard();
      });
    });
  }

  window._saveToFirebase = async (table, item) => {
    if (!useFirebase) return null;
    const r = await push(ref(db, `patrimonio/${table}`), item);
    return r.key;
  };

  window._removeFromFirebase = async (table, key) => {
    if (!useFirebase || !key) return;
    await remove(ref(db, `patrimonio/${table}/${key}`));
  };
</script>

<style>
:root {
  --black:   #080808;
  --black2:  #0f0f0f;
  --black3:  #161616;
  --black4:  #1e1e1e;
  --black5:  #282828;
  --gold:    #b8973a;
  --gold2:   #d4af57;
  --gold3:   #e8cc7a;
  --gold-bg: rgba(184,151,58,0.08);
  --gold-br: rgba(184,151,58,0.2);
  --white:   #f5f0e8;
  --grey1:   #8a8680;
  --grey2:   #5c5a56;
  --grey3:   #2e2c2a;
  --green:   #3d9970;
  --green-bg:rgba(61,153,112,0.1);
  --red:     #c0392b;
  --red-bg:  rgba(192,57,43,0.1);
  --amber:   #d4a017;
  --amber-bg:rgba(212,160,23,0.1);
  --blue:    #2980b9;
  --blue-bg: rgba(41,128,185,0.1);
  --border:  rgba(255,255,255,0.06);
  --border2: rgba(255,255,255,0.03);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
html{scroll-behavior:smooth;}
body{font-family:'Outfit',sans-serif;background:var(--black);color:var(--white);min-height:100vh;overflow-x:hidden;-webkit-font-smoothing:antialiased;}
body::after{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='300' height='300' filter='url(%23n)' opacity='0.025'/%3E%3C/svg%3E");pointer-events:none;z-index:9999;}

.shell{display:flex;height:100vh;overflow:hidden;}

/* SIDEBAR */
.sidebar{width:220px;flex-shrink:0;background:var(--black2);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow-y:auto;}
.brand{padding:24px 20px 20px;border-bottom:1px solid var(--border);}
.brand-name{font-family:'Playfair Display',serif;font-size:16px;font-weight:600;color:var(--gold2);}
.brand-sub{font-size:9.5px;color:var(--grey2);letter-spacing:2.5px;text-transform:uppercase;margin-top:3px;}
.sync-row{display:flex;align-items:center;gap:6px;margin-top:8px;}
.sync-dot{width:5px;height:5px;border-radius:50%;background:var(--amber);flex-shrink:0;}
.sync-text{font-size:9px;color:var(--grey2);letter-spacing:1px;}

.profiles{padding:16px 16px 12px;border-bottom:1px solid var(--border);}
.profiles-label{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--grey2);margin-bottom:8px;}
.profile-btn{display:flex;align-items:center;gap:9px;width:100%;padding:8px;border-radius:5px;border:none;background:transparent;color:var(--grey1);cursor:pointer;font-family:'Outfit',sans-serif;font-size:13px;transition:all 0.15s;text-align:left;margin-bottom:2px;}
.profile-btn:hover{background:var(--black4);color:var(--white);}
.profile-btn.active{background:var(--gold-bg);color:var(--gold2);border:1px solid var(--gold-br);}
.profile-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;}
.dot-d{background:var(--blue);}
.dot-v{background:var(--green);}

.nav{padding:12px 16px;flex:1;}
.nav-section{font-size:9px;letter-spacing:2.5px;text-transform:uppercase;color:var(--grey2);padding:0 8px;margin:14px 0 5px;}
.nav-section:first-child{margin-top:0;}
.nav-btn{display:flex;align-items:center;gap:9px;width:100%;padding:8px;border-radius:5px;border:none;background:transparent;color:var(--grey1);cursor:pointer;font-family:'Outfit',sans-serif;font-size:12.5px;transition:all 0.15s;text-align:left;margin-bottom:1px;white-space:nowrap;}
.nav-btn:hover{background:var(--black4);color:var(--white);}
.nav-btn.active{background:var(--black5);color:var(--white);}
.nav-btn.active .nav-ind{background:var(--gold);}
.nav-ind{width:3px;height:12px;border-radius:2px;background:transparent;flex-shrink:0;transition:background 0.15s;}
.nav-badge{margin-left:auto;background:var(--red-bg);color:var(--red);font-size:9px;padding:1px 5px;border-radius:3px;font-weight:500;}

/* MAIN */
.main{flex:1;overflow-y:auto;overflow-x:hidden;background:var(--black);}

/* TOPBAR */
.topbar{display:flex;align-items:center;justify-content:space-between;padding:18px 32px;border-bottom:1px solid var(--border);position:sticky;top:0;background:rgba(8,8,8,0.96);backdrop-filter:blur(12px);z-index:100;}
.topbar-title{font-family:'Playfair Display',serif;font-size:20px;font-weight:500;}
.topbar-title span{color:var(--gold2);}
.topbar-date{font-size:10.5px;color:var(--grey1);margin-top:2px;letter-spacing:0.3px;}
.topbar-right{display:flex;align-items:center;gap:8px;}

/* PAGES */
.page{display:none;padding:28px 32px 48px;}
.page.active{display:block;animation:fadeUp 0.22s ease;}
@keyframes fadeUp{from{opacity:0;transform:translateY(5px);}to{opacity:1;transform:translateY(0);}}

/* STAT CARDS */
.stat-row{display:grid;gap:1px;margin-bottom:24px;background:var(--border);border:1px solid var(--border);border-radius:8px;overflow:hidden;}
.stat-row-4{grid-template-columns:repeat(4,1fr);}
.stat-row-3{grid-template-columns:repeat(3,1fr);}
.stat-row-2{grid-template-columns:repeat(2,1fr);}
.stat-card{background:var(--black2);padding:20px 22px;transition:background 0.15s;}
.stat-card:hover{background:var(--black3);}
.stat-label{font-size:9.5px;letter-spacing:2px;text-transform:uppercase;color:var(--grey1);margin-bottom:10px;}
.stat-value{font-family:'Playfair Display',serif;font-size:26px;font-weight:500;line-height:1;color:var(--white);}
.stat-value.gold{color:var(--gold2);}
.stat-value.green{color:var(--green);}
.stat-value.red{color:var(--red);}
.stat-value.blue{color:var(--blue);}
.stat-sub{font-family:'JetBrains Mono',monospace;font-size:9.5px;color:var(--grey2);margin-top:7px;}

/* PANELS */
.panel-row{display:grid;gap:18px;margin-bottom:18px;}
.pr2{grid-template-columns:1fr 1fr;}
.pr21{grid-template-columns:2fr 1fr;}
.pr12{grid-template-columns:1fr 2fr;}
.panel{background:var(--black2);border:1px solid var(--border);border-radius:8px;overflow:hidden;}
.panel-header{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;border-bottom:1px solid var(--border);}
.panel-title{font-size:10.5px;letter-spacing:1.5px;text-transform:uppercase;color:var(--grey1);font-weight:500;}
.panel-body{padding:18px 20px;}
.panel-body-0{padding:0;}

/* FORMS */
.form-grid{display:grid;gap:12px;}
.fg2{grid-template-columns:1fr 1fr;}
.fg3{grid-template-columns:1fr 1fr 1fr;}
.full{grid-column:1/-1;}
.field{display:flex;flex-direction:column;gap:5px;}
.field label{font-size:9.5px;letter-spacing:1.5px;text-transform:uppercase;color:var(--grey1);}
.field input,.field select,.field textarea{background:var(--black3);border:1px solid var(--border);border-radius:5px;padding:9px 12px;color:var(--white);font-family:'Outfit',sans-serif;font-size:13px;outline:none;transition:border-color 0.15s;width:100%;appearance:none;}
.field input:focus,.field select:focus,.field textarea:focus{border-color:var(--gold-br);}
.field select{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%235c5a56'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;padding-right:28px;}
.field textarea{resize:vertical;min-height:80px;line-height:1.5;}

/* BUTTONS */
.btn{padding:9px 18px;border-radius:5px;border:none;cursor:pointer;font-family:'Outfit',sans-serif;font-size:12.5px;font-weight:500;transition:all 0.15s;white-space:nowrap;display:inline-flex;align-items:center;gap:6px;}
.btn-gold{background:var(--gold);color:var(--black);}
.btn-gold:hover{background:var(--gold2);}
.btn-ghost{background:transparent;border:1px solid var(--border);color:var(--grey1);}
.btn-ghost:hover{border-color:var(--gold-br);color:var(--gold2);}
.btn-danger{background:var(--red-bg);color:var(--red);border:1px solid rgba(192,57,43,0.2);}
.btn-green{background:var(--green-bg);color:var(--green);border:1px solid rgba(61,153,112,0.2);}
.btn-sm{padding:5px 10px;font-size:11px;}
.btn-full{width:100%;justify-content:center;}

/* TABS */
.tabs{display:flex;background:var(--black3);border:1px solid var(--border);border-radius:5px;padding:3px;gap:2px;}
.tab{flex:1;padding:6px 10px;border-radius:3px;border:none;background:transparent;color:var(--grey1);cursor:pointer;font-family:'Outfit',sans-serif;font-size:12px;font-weight:500;transition:all 0.15s;}
.tab.active{background:var(--black5);color:var(--white);}

/* TABLE */
.tbl-wrap{overflow-x:auto;}
table{width:100%;border-collapse:collapse;}
thead tr{border-bottom:1px solid var(--border);}
th{text-align:left;padding:9px 14px;font-size:9.5px;letter-spacing:1.5px;text-transform:uppercase;color:var(--grey2);font-weight:500;white-space:nowrap;}
td{padding:11px 14px;font-size:12.5px;color:var(--grey1);border-bottom:1px solid var(--border2);white-space:nowrap;}
tbody tr:hover td{background:var(--black3);color:var(--white);}
tbody tr:last-child td{border-bottom:none;}

/* BADGE */
.badge{display:inline-block;padding:2px 7px;border-radius:3px;font-size:9.5px;font-weight:500;letter-spacing:0.5px;text-transform:uppercase;}
.b-green{background:var(--green-bg);color:var(--green);}
.b-red{background:var(--red-bg);color:var(--red);}
.b-gold{background:var(--gold-bg);color:var(--gold2);}
.b-amber{background:var(--amber-bg);color:var(--amber);}
.b-blue{background:var(--blue-bg);color:var(--blue);}
.b-grey{background:var(--black5);color:var(--grey1);}

/* PROGRESS */
.prog-wrap{margin-bottom:14px;}
.prog-header{display:flex;justify-content:space-between;margin-bottom:5px;font-size:12px;color:var(--grey1);}
.prog-pct{color:var(--gold2);font-family:'JetBrains Mono',monospace;font-size:10px;}
.prog-bar{height:3px;background:var(--black5);border-radius:2px;overflow:hidden;}
.prog-fill{height:100%;border-radius:2px;transition:width 0.8s cubic-bezier(.4,0,.2,1);}
.fill-gold{background:var(--gold2);}
.fill-green{background:var(--green);}
.fill-red{background:var(--red);}
.fill-blue{background:var(--blue);}
.fill-amber{background:var(--amber);}

/* TX LIST */
.tx-item{display:flex;align-items:center;gap:11px;padding:10px 0;border-bottom:1px solid var(--border2);}
.tx-item:last-child{border-bottom:none;}
.tx-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;}
.tx-info{flex:1;min-width:0;}
.tx-desc{font-size:12.5px;color:var(--white);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.tx-meta{font-size:10px;color:var(--grey2);margin-top:2px;}
.tx-val{font-family:'JetBrains Mono',monospace;font-size:12.5px;font-weight:500;white-space:nowrap;}
.tx-date{font-size:9.5px;color:var(--grey2);font-family:'JetBrains Mono',monospace;}

/* ALERT CARD */
.alert-card{display:flex;align-items:center;gap:12px;padding:12px 14px;border-radius:6px;border:1px solid var(--border);margin-bottom:8px;background:var(--black3);transition:all 0.15s;}
.alert-card.urgent{border-color:rgba(192,57,43,0.3);background:rgba(192,57,43,0.05);}
.alert-card.soon{border-color:rgba(212,160,23,0.3);background:rgba(212,160,23,0.05);}
.alert-card.ok{border-color:rgba(61,153,112,0.2);}
.alert-dot-lg{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.alert-body{flex:1;}
.alert-name{font-size:13px;color:var(--white);font-weight:500;}
.alert-sub{font-size:10.5px;color:var(--grey2);margin-top:2px;}
.alert-val{font-family:'JetBrains Mono',monospace;font-size:13px;}

/* BAR CHART */
.bar-chart{display:flex;align-items:flex-end;gap:10px;height:110px;padding-top:8px;}
.bar-col{flex:1;display:flex;flex-direction:column;align-items:center;gap:5px;}
.bar-col-label{font-size:9px;color:var(--grey2);letter-spacing:0.3px;text-align:center;line-height:1.3;}
.bar-col-val{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--grey1);}
.bar-bar{width:100%;border-radius:2px 2px 0 0;min-height:2px;transition:height 0.7s cubic-bezier(.4,0,.2,1);}

/* CALENDAR */
.calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;}
.cal-header{font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--grey2);text-align:center;padding:4px 0;}
.cal-day{aspect-ratio:1;border-radius:5px;display:flex;align-items:center;justify-content:center;font-size:11px;cursor:default;border:1px solid transparent;transition:all 0.1s;}
.cal-day.empty{background:transparent;}
.cal-day.green{background:rgba(61,153,112,0.2);color:var(--green);border-color:rgba(61,153,112,0.2);}
.cal-day.amber{background:rgba(212,160,23,0.15);color:var(--amber);border-color:rgba(212,160,23,0.2);}
.cal-day.red{background:rgba(192,57,43,0.15);color:var(--red);border-color:rgba(192,57,43,0.2);}
.cal-day.no-data{background:var(--black3);color:var(--grey2);}
.cal-day.today{border-color:var(--gold-br)!important;}

/* SIMULADOR */
.sim-result{margin-top:16px;padding:14px;border-radius:6px;border:1px solid var(--border);display:none;animation:fadeUp 0.2s ease;}
.sim-result.sim-green{border-color:rgba(61,153,112,0.3);background:rgba(61,153,112,0.05);}
.sim-result.sim-amber{border-color:rgba(212,160,23,0.3);background:rgba(212,160,23,0.05);}
.sim-result.sim-red{border-color:rgba(192,57,43,0.3);background:rgba(192,57,43,0.05);}

/* CENTRAL IA */
.ia-chat{display:flex;flex-direction:column;gap:12px;max-height:400px;overflow-y:auto;padding:4px;}
.ia-msg{padding:12px 14px;border-radius:6px;font-size:12.5px;line-height:1.7;}
.ia-msg.user{background:var(--black4);border:1px solid var(--border);color:var(--white);text-align:right;}
.ia-msg.assistant{background:var(--gold-bg);border:1px solid var(--gold-br);color:var(--white);}
.ia-loading{display:flex;gap:4px;align-items:center;padding:10px 14px;}
.ia-dot{width:5px;height:5px;border-radius:50%;background:var(--gold);animation:pulse 1.2s infinite;}
.ia-dot:nth-child(2){animation-delay:0.2s;}
.ia-dot:nth-child(3){animation-delay:0.4s;}
@keyframes pulse{0%,100%{opacity:0.3;}50%{opacity:1;}}

/* TOAST */
.toast{position:fixed;bottom:24px;right:24px;background:var(--black4);border:1px solid var(--gold-br);border-radius:6px;padding:11px 16px;font-size:12px;color:var(--white);z-index:9998;transform:translateY(80px);opacity:0;transition:all 0.3s cubic-bezier(.34,1.4,.64,1);display:flex;align-items:center;gap:8px;}
.toast.show{transform:translateY(0);opacity:1;}
.toast-dot{width:5px;height:5px;border-radius:50%;background:var(--gold2);}

/* TORNEIRA ALERT */
.torneira-banner{display:none;margin-bottom:20px;padding:12px 16px;border-radius:6px;border:1px solid rgba(192,57,43,0.4);background:rgba(192,57,43,0.08);font-size:12.5px;color:var(--red);line-height:1.6;}

/* FECHAMENTO DO MES */
.mes-card{background:var(--gold-bg);border:1px solid var(--gold-br);border-radius:8px;padding:20px;margin-bottom:20px;display:none;}

/* GOAL CARD */
.goal-card{background:var(--black2);border:1px solid var(--border);border-radius:8px;padding:16px 18px;margin-bottom:10px;}
.goal-name{font-size:13px;font-weight:500;color:var(--white);}
.goal-target{font-size:10.5px;color:var(--grey2);margin:2px 0 12px;}
.goal-cur{font-family:'JetBrains Mono',monospace;font-size:18px;color:var(--gold2);margin-bottom:10px;}
.goal-eta{font-size:10.5px;color:var(--grey2);margin-top:6px;}
.goal-tip{font-size:11px;color:var(--amber);margin-top:8px;padding:7px 10px;background:var(--amber-bg);border-radius:4px;line-height:1.5;}

/* CAT TREE */
.cat-breadcrumb{display:flex;align-items:center;gap:5px;font-size:10.5px;color:var(--grey2);margin-bottom:8px;flex-wrap:wrap;}
.cat-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:6px;}
.cat-opt{padding:8px 10px;background:var(--black3);border:1px solid var(--border);border-radius:4px;cursor:pointer;font-size:11.5px;color:var(--grey1);transition:all 0.12s;text-align:left;font-family:'Outfit',sans-serif;}
.cat-opt:hover{background:var(--black5);color:var(--white);border-color:var(--gold-br);}
.cat-opt.selected{background:var(--gold-bg);color:var(--gold2);border-color:var(--gold-br);}
.cat-back{display:inline-flex;align-items:center;gap:5px;padding:5px 0;font-size:11px;color:var(--grey2);cursor:pointer;background:none;border:none;font-family:'Outfit',sans-serif;margin-bottom:8px;transition:color 0.12s;}
.cat-back:hover{color:var(--gold2);}

/* BANK CARD */
.bank-card{background:var(--black3);border:1px solid var(--border);border-radius:8px;padding:16px 18px;position:relative;overflow:hidden;}
.bank-inst{font-size:9.5px;letter-spacing:1.5px;text-transform:uppercase;color:var(--grey2);margin-bottom:8px;}
.bank-bal{font-family:'Playfair Display',serif;font-size:22px;color:var(--white);margin-bottom:10px;}
.bank-meta{display:flex;justify-content:space-between;align-items:center;font-size:10.5px;color:var(--grey2);}

.divider{height:1px;background:var(--border);margin:20px 0;}
.section-title{font-family:'Playfair Display',serif;font-size:17px;font-weight:500;color:var(--white);margin-bottom:14px;padding-bottom:12px;border-bottom:1px solid var(--border);}
.flex-between{display:flex;justify-content:space-between;align-items:center;}
.flex-center{display:flex;align-items:center;}
.gap-8{gap:8px;}
.gap-10{gap:10px;}
.mono{font-family:'JetBrains Mono',monospace;}
.fs-11{font-size:11px;}
.fs-12{font-size:12px;}
.fs-13{font-size:13px;}
.text-grey{color:var(--grey1);}
.text-gold{color:var(--gold2);}
.text-green{color:var(--green);}
.text-red{color:var(--red);}
.text-amber{color:var(--amber);}
.mt-8{margin-top:8px;}
.mt-12{margin-top:12px;}
.mt-16{margin-top:16px;}
.mt-20{margin-top:20px;}
.mb-12{margin-bottom:12px;}
.mb-16{margin-bottom:16px;}
.mb-20{margin-bottom:20px;}

.line-chart-wrap{position:relative;height:100px;margin-top:8px;}
svg.line-chart{width:100%;height:100%;}

/* PROFILE BANNER */
.profile-banner{padding:10px 16px;font-size:11px;color:var(--grey1);border-bottom:1px solid var(--border);background:var(--black3);text-align:center;letter-spacing:0.5px;}
.profile-banner span{color:var(--gold2);font-weight:500;}
</style>
</head>
<body>
<div class="shell">

<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="brand">
    <div class="brand-name">Patrimônio</div>
    <div class="brand-sub">Diego & Dinha</div>
    <div class="sync-row">
      <div class="sync-dot" id="sync-dot"></div>
      <div class="sync-text" id="sync-status">Local (configure Firebase)</div>
    </div>
  </div>

  <div class="profiles">
    <div class="profiles-label">Perfil ativo</div>
    <button class="profile-btn active" onclick="setProfile('diego',this)">
      <div class="profile-dot dot-d"></div>Diego
    </button>
    <button class="profile-btn" onclick="setProfile('dinha',this)">
      <div class="profile-dot dot-v"></div>Dinha
    </button>
  </div>

  <nav class="nav">
    <div class="nav-section">Visão Geral</div>
    <button class="nav-btn active" onclick="go('dashboard',this)"><div class="nav-ind"></div>Dashboard</button>
    <button class="nav-btn" onclick="go('consolidado',this)"><div class="nav-ind"></div>Visão do Casal</button>
    <button class="nav-btn" onclick="go('calendario',this)"><div class="nav-ind"></div>Calendário</button>
    <button class="nav-btn" onclick="go('alertas',this)">
      <div class="nav-ind"></div>Alertas
      <span class="nav-badge" id="alertas-badge" style="display:none;">0</span>
    </button>

    <div class="nav-section">Registros</div>
    <button class="nav-btn" onclick="go('lancamentos',this)"><div class="nav-ind"></div>Lançamentos</button>
    <button class="nav-btn" onclick="go('recorrentes',this)"><div class="nav-ind"></div>Contas Fixas</button>
    <button class="nav-btn" onclick="go('dividas',this)"><div class="nav-ind"></div>Dívidas</button>
    <button class="nav-btn" onclick="go('metas',this)"><div class="nav-ind"></div>Metas & Objetivos</button>
    <button class="nav-btn" onclick="go('simulador',this)"><div class="nav-ind"></div>Simulador de Compra</button>
    <button class="nav-btn" onclick="go('contas',this)"><div class="nav-ind"></div>Contas & Bancos</button>

    <div class="nav-section">Projetos</div>
    <button class="nav-btn" onclick="go('empadas',this)"><div class="nav-ind"></div>Empadas da Dinha</button>
    <button class="nav-btn" onclick="go('laromme',this)"><div class="nav-ind"></div>Laromme</button>

    <div class="nav-section">Estratégia</div>
    <button class="nav-btn" onclick="go('central',this)"><div class="nav-ind"></div>Central do Dinheiro</button>
    <button class="nav-btn" onclick="go('investimentos',this)"><div class="nav-ind"></div>Carteira</button>
    <button class="nav-btn" onclick="go('relatorio',this)"><div class="nav-ind"></div>Relatório Mensal</button>
  </nav>
</aside>

<!-- MAIN -->
<div class="main">
  <div class="topbar">
    <div>
      <div class="topbar-title" id="top-title">Dashboard</div>
      <div class="topbar-date" id="top-date"></div>
    </div>
    <div class="topbar-right">
      <div class="profile-banner" style="border-radius:5px;padding:5px 12px;background:var(--black3);">
        Logado como <span id="top-profile">Diego</span>
      </div>
      <button class="btn btn-ghost btn-sm" onclick="go('lancamentos',null)">+ Lançamento</button>
      <button class="btn btn-gold btn-sm" onclick="go('central',null)">Central do Dinheiro</button>
    </div>
  </div>

  <!-- ═══ DASHBOARD ═══ -->
  <div class="page active" id="page-dashboard">
    <div class="torneira-banner" id="torneira-banner"></div>
    <div class="stat-row stat-row-4">
      <div class="stat-card"><div class="stat-label">Renda Líquida</div><div class="stat-value green mono" id="s-renda">R$ 0</div><div class="stat-sub">Mês corrente</div></div>
      <div class="stat-card"><div class="stat-label">Gastos Totais</div><div class="stat-value red mono" id="s-gastos">R$ 0</div><div class="stat-sub" id="s-taxa">0% da renda</div></div>
      <div class="stat-card"><div class="stat-label">Saldo Disponível</div><div class="stat-value gold mono" id="s-saldo">R$ 0</div><div class="stat-sub">Após gastos</div></div>
      <div class="stat-card"><div class="stat-label">Para Investir (20%)</div><div class="stat-value mono" id="s-invest">R$ 0</div><div class="stat-sub">Meta recomendada</div></div>
    </div>

    <!-- SALDO LIVRE TIP -->
    <div id="saldo-tip" style="display:none;margin-bottom:20px;padding:11px 14px;border-radius:6px;border:1px solid var(--gold-br);background:var(--gold-bg);font-size:12px;color:var(--gold2);line-height:1.6;"></div>

    <div class="panel-row pr21">
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">Distribuição — 50 / 30 / 20</div>
          <div class="fs-11 text-grey mono" id="db-month"></div>
        </div>
        <div class="panel-body">
          <div class="bar-chart">
            <div class="bar-col"><div class="bar-col-val" id="bc-nec-v">—</div><div class="bar-bar" id="bc-nec" style="height:3px;background:var(--blue);"></div><div class="bar-col-label">Necessidades<br>50%</div></div>
            <div class="bar-col"><div class="bar-col-val" id="bc-des-v">—</div><div class="bar-bar" id="bc-des" style="height:3px;background:var(--amber);"></div><div class="bar-col-label">Desejos<br>30%</div></div>
            <div class="bar-col"><div class="bar-col-val" id="bc-inv-v">—</div><div class="bar-bar" id="bc-inv" style="height:3px;background:var(--green);"></div><div class="bar-col-label">Investimentos<br>20%</div></div>
            <div class="bar-col"><div class="bar-col-val" id="bc-div-v">—</div><div class="bar-bar" id="bc-div" style="height:3px;background:var(--red);"></div><div class="bar-col-label">Dívidas</div></div>
          </div>
          <div class="divider" style="margin:14px 0;"></div>
          <div class="stat-label mb-12">Análise Inteligente</div>
          <div id="ai-items" style="display:flex;flex-direction:column;gap:7px;"><div class="fs-12 text-grey">Registre transações para ativar.</div></div>
        </div>
      </div>

      <div style="display:flex;flex-direction:column;gap:18px;">
        <div class="panel">
          <div class="panel-header"><div class="panel-title">Alertas Ativos</div><button class="btn btn-ghost btn-sm" onclick="go('alertas',null)">Ver todos</button></div>
          <div class="panel-body" id="db-alertas"><div class="fs-12 text-grey">Nenhum alerta.</div></div>
        </div>
        <div class="panel">
          <div class="panel-header"><div class="panel-title">Metas</div></div>
          <div class="panel-body" id="db-metas"><div class="fs-12 text-grey">Nenhuma meta.</div></div>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="panel-header"><div class="panel-title">Últimas Transações</div><button class="btn btn-ghost btn-sm" onclick="go('lancamentos',null)">Ver todas</button></div>
      <div id="db-tx" style="padding:8px 20px;"><div class="fs-12 text-grey" style="padding:12px 0;">Nenhum lançamento ainda.</div></div>
    </div>
  </div>

  <!-- ═══ VISÃO DO CASAL ═══ -->
  <div class="page" id="page-consolidado">
    <div class="stat-row stat-row-4">
      <div class="stat-card"><div class="stat-label">Renda Total do Casal</div><div class="stat-value green mono" id="cas-renda">R$ 0</div></div>
      <div class="stat-card"><div class="stat-label">Gastos Totais</div><div class="stat-value red mono" id="cas-gastos">R$ 0</div></div>
      <div class="stat-card"><div class="stat-label">Saldo Consolidado</div><div class="stat-value gold mono" id="cas-saldo">R$ 0</div></div>
      <div class="stat-card"><div class="stat-label">Dívidas (casal)</div><div class="stat-value red mono" id="cas-dividas">R$ 0</div></div>
    </div>
    <div class="panel-row pr2">
      <div class="panel">
        <div class="panel-header"><div class="panel-title">Diego</div></div>
        <div class="panel-body" id="cas-diego"></div>
      </div>
      <div class="panel">
        <div class="panel-header"><div class="panel-title">Dinha</div></div>
        <div class="panel-body" id="cas-dinha"></div>
      </div>
    </div>
    <div class="panel mb-16">
      <div class="panel-header"><div class="panel-title">Todas as Transações — Casal</div>
        <div style="display:flex;gap:8px;">
          <button class="btn btn-ghost btn-sm" onclick="exportCSV()">Exportar CSV</button>
          <button class="btn btn-gold btn-sm" onclick="exportPDFConsolidado()">Exportar PDF</button>
        </div>
      </div>
      <div class="tbl-wrap">
        <table>
          <thead><tr><th>Data</th><th>Descrição</th><th>Categoria</th><th>Tipo</th><th>Titular</th><th>Valor</th></tr></thead>
          <tbody id="cas-tx-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ═══ CALENDÁRIO ═══ -->
  <div class="page" id="page-calendario">
    <div class="panel-row pr2">
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title" id="cal-title">Calendário Financeiro</div>
          <div style="display:flex;gap:8px;">
            <button class="btn btn-ghost btn-sm" onclick="calNav(-1)">&#8592;</button>
            <button class="btn btn-ghost btn-sm" onclick="calNav(1)">&#8594;</button>
          </div>
        </div>
        <div class="panel-body">
          <div class="calendar-grid" id="cal-grid"></div>
          <div style="display:flex;gap:16px;margin-top:14px;" class="fs-11 text-grey">
            <span><span style="color:var(--green);">&#9632;</span> Bom dia</span>
            <span><span style="color:var(--amber);">&#9632;</span> Atenção</span>
            <span><span style="color:var(--red);">&#9632;</span> Alto gasto</span>
            <span><span style="color:var(--grey2);">&#9632;</span> Sem registro</span>
          </div>
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:18px;">
        <div class="panel">
          <div class="panel-header"><div class="panel-title">Tendências</div></div>
          <div class="panel-body">
            <div class="stat-label mb-12">Gasto por Dia da Semana</div>
            <div class="bar-chart" id="week-chart" style="height:80px;"></div>
            <div class="divider" style="margin:14px 0;"></div>
            <div class="stat-label mb-12">Análise do Período</div>
            <div id="cal-insights" class="fs-12 text-grey">Sem dados suficientes.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ═══ ALERTAS ═══ -->
  <div class="page" id="page-alertas">
    <div class="flex-between mb-20">
      <div class="section-title" style="margin:0;border:none;padding:0;">Central de Alertas</div>
    </div>
    <div id="alertas-urgentes" class="mb-20"></div>
    <div id="alertas-list"><div class="fs-12 text-grey">Nenhum alerta configurado. Registre contas fixas para ativar alertas.</div></div>
  </div>

  <!-- ═══ LANÇAMENTOS ═══ -->
  <div class="page" id="page-lancamentos">
    <div class="panel-row pr12">
      <div class="panel">
        <div class="panel-header"><div class="panel-title">Novo Lançamento</div></div>
        <div class="panel-body">
          <div class="field mb-16"><label>Tipo</label>
            <div class="tabs" style="margin-top:5px;"><button class="tab active" id="tab-e" onclick="setLancTipo('entrada')">Entrada</button><button class="tab" id="tab-s" onclick="setLancTipo('saida')">Saída</button></div>
          </div>
          <div class="field mb-16"><label>Categoria</label>
            <div id="cat-breadcrumb" class="cat-breadcrumb" style="display:none;margin-top:5px;"></div>
            <div id="cat-tree" style="margin-top:5px;"></div>
            <input type="hidden" id="cat-selected">
          </div>
          <div class="form-grid fg2" style="gap:11px;">
            <div class="field full"><label>Descrição</label><input id="l-desc" placeholder="Ex: Salário, Mercado, Uber..."></div>
            <div class="field"><label>Valor (R$)</label><input id="l-valor" type="number" placeholder="0.00"></div>
            <div class="field"><label>Data</label><input id="l-data" type="date"></div>
            <div class="field"><label>Titular</label><select id="l-owner"><option>Diego</option><option>Dinha</option></select></div>
            <div class="field"><label>Natureza</label><select id="l-nat"><option>Fixo</option><option>Variável</option><option>Pontual</option></select></div>
          </div>
          <button class="btn btn-gold btn-full mt-16" onclick="saveLanc()">Registrar</button>
        </div>
      </div>
      <div class="panel">
        <div class="panel-header"><div class="panel-title">Histórico</div></div>
        <div id="lanc-list" style="padding:10px 18px;"><div class="fs-12 text-grey">Nenhum lançamento.</div></div>
      </div>
    </div>
  </div>

  <!-- ═══ CONTAS FIXAS / RECORRENTES ═══ -->
  <div class="page" id="page-recorrentes">
    <div class="panel-row pr2">
      <div class="panel">
        <div class="panel-header"><div class="panel-title">Cadastrar Conta Fixa</div></div>
        <div class="panel-body">
          <div class="form-grid fg2" style="gap:11px;">
            <div class="field full"><label>Descrição</label><input id="rec-desc" placeholder="Aluguel, Netflix, Plano de Saúde..."></div>
            <div class="field"><label>Valor (R$)</label><input id="rec-valor" type="number" placeholder="0.00"></div>
            <div class="field"><label>Dia de Vencimento</label><input id="rec-dia" type="number" min="1" max="31" placeholder="Ex: 10"></div>
            <div class="field"><label>Categoria</label><select id="rec-cat">
              <option>Moradia</option><option>Alimentação</option><option>Transporte</option>
              <option>Streaming</option><option>Saúde</option><option>Educação</option>
              <option>Assinatura</option><option>Dívida / Parcela</option><option>Outro</option>
            </select></div>
            <div class="field"><label>Titular</label><select id="rec-owner"><option>Diego</option><option>Dinha</option><option>Casal</option></select></div>
            <div class="field"><label>Alertar com antecedência</label><select id="rec-alert">
              <option value="15">15 dias antes</option>
              <option value="5">5 dias antes</option>
              <option value="1">No dia</option>
              <option value="0">Não alertar</option>
            </select></div>
          </div>
          <button class="btn btn-gold btn-full mt-16" onclick="saveRecorrente()">Cadastrar Conta Fixa</button>
        </div>
      </div>
      <div class="panel">
        <div class="panel-header"><div class="panel-title">Contas Fixas Cadastradas</div></div>
        <div class="panel-body" id="rec-list"><div class="fs-12 text-grey">Nenhuma conta fixa cadastrada.</div></div>
      </div>
    </div>
  </div>

  <!-- ═══ DÍVIDAS ═══ -->
  <div class="page" id="page-dividas">
    <div class="panel-row pr2">
      <div class="panel">
        <div class="panel-header"><div class="panel-title">Cadastrar Dívida</div></div>
        <div class="panel-body">
          <div class="form-grid fg2" style="gap:11px;">
            <div class="field full"><label>Descrição</label><input id="d-desc" placeholder="Cartão Nubank, Empréstimo..."></div>
            <div class="field"><label>Valor Total (R$)</label><input id="d-total" type="number" placeholder="0.00"></div>
            <div class="field"><label>Parcela Mensal (R$)</label><input id="d-parcela" type="number" placeholder="0.00"></div>
            <div class="field"><label>Juros (% a.m.)</label><input id="d-juros" type="number" placeholder="0.00" step="0.01"></div>
            <div class="field"><label>Titular</label><select id="d-owner"><option>Diego</option><option>Dinha</option><option>Casal</option></select></div>
          </div>
          <button class="btn btn-gold btn-full mt-16" onclick="saveDivida()">Cadastrar</button>
        </div>
      </div>
      <div>
        <div class="stat-row stat-row-2 mb-16">
          <div class="stat-card"><div class="stat-label">Total em Dívidas</div><div class="stat-value red mono" id="d-sum">R$ 0</div></div>
          <div class="stat-card"><div class="stat-label">Prazo para Quitar</div><div class="stat-value gold mono" id="d-prazo">—</div></div>
        </div>
        <div class="panel">
          <div class="panel-header"><div class="panel-title">Dívidas Ativas</div></div>
          <div class="panel-body" id="dividas-list"><div class="fs-12 text-grey">Nenhuma dívida.</div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ═══ METAS ═══ -->
  <div class="page" id="page-metas">
    <div class="panel-row pr2">
      <div class="panel">
        <div class="panel-header"><div class="panel-title">Nova Meta</div></div>
        <div class="panel-body">
          <div class="form-grid fg2" style="gap:11px;">
            <div class="field full"><label>Nome da Meta</label><input id="m-nome" placeholder="Casamento, Viagem, Carro..."></div>
            <div class="field"><label>Valor Total (R$)</label><input id="m-total" type="number" placeholder="0.00"></div>
            <div class="field"><label>Já Guardado (R$)</label><input id="m-atual" type="number" placeholder="0.00"></div>
            <div class="field"><label>Aporte Mensal (R$)</label><input id="m-aporte" type="number" placeholder="0.00"></div>
            <div class="field"><label>Titular</label><select id="m-owner"><option>Diego</option><option>Dinha</option><option>Casal</option></select></div>
            <div class="field"><label>Tipo de Objetivo</label><select id="m-tipo">
              <option>Viagem</option><option>Casamento</option><option>Carro</option>
              <option>Imóvel</option><option>Reserva de Emergência</option><option>Outro</option>
            </select></div>
          </div>
          <button class="btn btn-gold btn-full mt-16" onclick="saveMeta()">Adicionar Meta</button>
        </div>
      </div>
      <div id="metas-list"><div class="panel"><div class="panel-body"><div class="fs-12 text-grey">Nenhuma meta.</div></div></div></div>
    </div>
  </div>

  <!-- ═══ SIMULADOR ═══ -->
  <div class="page" id="page-simulador">
    <div class="panel-row pr2">
      <div class="panel">
        <div class="panel-header"><div class="panel-title">Simulador de Compra</div></div>
        <div class="panel-body">
          <div class="form-grid" style="gap:11px;">
            <div class="field"><label>Descrição do Item</label><input id="sim-desc" placeholder="MacBook Air M2, iPhone 15..."></div>
            <div class="field"><label>Valor Total (R$)</label><input id="sim-valor" type="number" placeholder="0.00" oninput="runSim()"></div>
            <div class="field"><label>Forma de Pagamento</label><select id="sim-forma" onchange="runSim()"><option>Débito / Pix à vista</option><option>Crédito à vista</option><option>Crédito parcelado</option></select></div>
            <div class="field" id="sim-parc-wrap" style="display:none;"><label>Parcelas</label><select id="sim-parcelas" onchange="runSim()"><option>2</option><option>3</option><option>4</option><option>6</option><option>10</option><option>12</option></select></div>
          </div>
          <button class="btn btn-gold btn-full mt-16" onclick="runSim()">Analisar</button>
          <div id="sim-result" class="sim-result"></div>
        </div>
      </div>
      <div class="panel">
        <div class="panel-header"><div class="panel-title">Como a Análise Funciona</div></div>
        <div class="panel-body fs-12 text-grey" style="line-height:1.8;">
          <div style="display:flex;flex-direction:column;gap:10px;">
            <div><span class="badge b-green">Verde</span> <span style="margin-left:6px;">Compra viável sem comprometer metas ou estabilidade.</span></div>
            <div><span class="badge b-amber">Amarelo</span> <span style="margin-left:6px;">Possível, mas exige atenção. Avalie a forma de pagamento.</span></div>
            <div><span class="badge b-red">Vermelho</span> <span style="margin-left:6px;">Risco real de comprometer sua organização financeira.</span></div>
            <div class="divider" style="margin:4px 0;"></div>
            A análise leva em conta saldo disponível, dívidas ativas, metas em andamento e renda cadastrada.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ═══ CONTAS & BANCOS ═══ -->
  <div class="page" id="page-contas">
    <div class="flex-between mb-20">
      <div class="section-title" style="margin:0;border:none;padding:0;">Contas & Bancos</div>
      <button class="btn btn-gold btn-sm" onclick="toggleEl('bank-form')">+ Adicionar Conta</button>
    </div>
    <div id="bank-form" style="display:none;" class="panel mb-20">
      <div class="panel-header"><div class="panel-title">Nova Conta</div></div>
      <div class="panel-body">
        <div class="form-grid fg2" style="gap:11px;">
          <div class="field"><label>Instituição</label><input id="b-nome" placeholder="Nubank, Itaú, Inter..."></div>
          <div class="field"><label>Tipo</label><select id="b-tipo"><option>Conta Corrente</option><option>Conta Digital</option><option>Poupança</option><option>Carteira de Investimentos</option></select></div>
          <div class="field"><label>Saldo (R$)</label><input id="b-saldo" type="number" placeholder="0.00"></div>
          <div class="field"><label>Titular</label><select id="b-owner"><option>Diego</option><option>Dinha</option><option>Casal</option></select></div>
        </div>
        <div style="display:flex;gap:8px;margin-top:12px;">
          <button class="btn btn-gold" onclick="saveBank()">Salvar</button>
          <button class="btn btn-ghost" onclick="toggleEl('bank-form')">Cancelar</button>
        </div>
      </div>
    </div>
    <div id="banks-grid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:14px;"></div>
  </div>

  <!-- ═══ EMPADAS ═══ -->
  <div class="page" id="page-empadas">
    <div class="stat-row stat-row-3 mb-20">
      <div class="stat-card"><div class="stat-label">Receita</div><div class="stat-value green mono" id="emp-r">R$ 0</div></div>
      <div class="stat-card"><div class="stat-label">Custos</div><div class="stat-value red mono" id="emp-c">R$ 0</div></div>
      <div class="stat-card"><div class="stat-label">Resultado</div><div class="stat-value gold mono" id="emp-l">R$ 0</div></div>
    </div>
    <div class="panel-row pr2">
      <div class="panel">
        <div class="panel-header"><div class="panel-title">Registrar</div></div>
        <div class="panel-body">
          <div class="field mb-16"><label>Tipo</label><div class="tabs" style="margin-top:5px;"><button class="tab active" id="emp-tab-r" onclick="setEmpTipo('receita')">Receita</button><button class="tab" id="emp-tab-c" onclick="setEmpTipo('custo')">Custo</button></div></div>
          <div id="emp-cat-wrap" style="display:none;" class="field mb-16"><label>Categoria</label>
            <div id="emp-cat-crumb" class="cat-breadcrumb" style="display:none;margin-top:5px;"></div>
            <div id="emp-cat-tree" style="margin-top:5px;"></div>
            <input type="hidden" id="emp-cat">
          </div>
          <div class="form-grid fg2" style="gap:11px;">
            <div class="field full"><label>Descrição</label><input id="emp-desc" placeholder="Venda de empadas, Farinha..."></div>
            <div class="field"><label>Valor (R$)</label><input id="emp-valor" type="number" placeholder="0.00"></div>
            <div class="field"><label>Data</label><input id="emp-data" type="date"></div>
            <div class="field full"><label>Banco / Conta Utilizada</label><input id="emp-banco" placeholder="Ex: Nubank pessoal da Dinha"></div>
          </div>
          <button class="btn btn-gold btn-full mt-16" onclick="saveEmpLanc()">Registrar</button>
        </div>
      </div>
      <div class="panel"><div class="panel-header"><div class="panel-title">Histórico</div></div><div id="emp-tx" style="padding:10px 18px;"><div class="fs-12 text-grey">Nenhum lançamento.</div></div></div>
    </div>
  </div>

  <!-- ═══ LAROMME ═══ -->
  <div class="page" id="page-laromme">
    <div class="stat-row stat-row-3 mb-20">
      <div class="stat-card"><div class="stat-label">Capital Investido</div><div class="stat-value blue mono" id="lar-i">R$ 0</div></div>
      <div class="stat-card"><div class="stat-label">Receita</div><div class="stat-value green mono" id="lar-r">R$ 0</div></div>
      <div class="stat-card"><div class="stat-label">Resultado</div><div class="stat-value gold mono" id="lar-l">R$ 0</div></div>
    </div>
    <div class="panel-row pr2">
      <div class="panel">
        <div class="panel-header"><div class="panel-title">Registrar</div></div>
        <div class="panel-body">
          <div class="field mb-16"><label>Tipo</label><div class="tabs" style="margin-top:5px;"><button class="tab active" id="lar-tab-i" onclick="setLarTipo('investimento')">Investimento</button><button class="tab" id="lar-tab-r" onclick="setLarTipo('receita')">Receita</button></div></div>
          <div class="field mb-16"><label>Categoria</label>
            <div id="lar-cat-crumb" class="cat-breadcrumb" style="display:none;margin-top:5px;"></div>
            <div id="lar-cat-tree" style="margin-top:5px;"></div>
            <input type="hidden" id="lar-cat">
          </div>
          <div class="form-grid fg2" style="gap:11px;">
            <div class="field full"><label>Descrição</label><input id="lar-desc" placeholder="Tecido, Costura, Venda..."></div>
            <div class="field"><label>Valor (R$)</label><input id="lar-valor" type="number" placeholder="0.00"></div>
            <div class="field"><label>Data</label><input id="lar-data" type="date"></div>
            <div class="field full"><label>Banco / Conta Utilizada</label><input id="lar-banco" placeholder="Ex: Nubank pessoal do Diego"></div>
          </div>
          <button class="btn btn-gold btn-full mt-16" onclick="saveLarLanc()">Registrar</button>
        </div>
      </div>
      <div class="panel"><div class="panel-header"><div class="panel-title">Histórico</div></div><div id="lar-tx" style="padding:10px 18px;"><div class="fs-12 text-grey">Nenhum lançamento.</div></div></div>
    </div>
  </div>

  <!-- ═══ CENTRAL DO DINHEIRO (IA) ═══ -->
  <div class="page" id="page-central">
    <div class="panel-row pr2">
      <div class="panel" style="display:flex;flex-direction:column;">
        <div class="panel-header"><div class="panel-title">Central do Dinheiro — Consultor Financeiro IA</div></div>
        <div class="panel-body" style="flex:1;display:flex;flex-direction:column;gap:14px;">
          <div class="fs-12 text-grey" style="line-height:1.7;">Descreva sua estratégia ou dúvida financeira. A IA analisa seus dados reais e responde como um consultor financeiro pessoal.</div>
          <div class="ia-chat" id="ia-chat"></div>
          <div style="display:flex;flex-direction:column;gap:8px;margin-top:auto;">
            <div class="field"><label>Sua estratégia ou pergunta</label>
              <textarea id="ia-input" placeholder='Ex: "Estou pensando em usar R$ 2.000 para pagar a fatura do cartão de crédito via acordo, recebi uma oferta de 80% de desconto. Faz sentido?"' style="min-height:90px;"></textarea>
            </div>
            <button class="btn btn-gold btn-full" onclick="sendToIA()">Consultar IA</button>
          </div>
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:18px;">
        <div class="panel">
          <div class="panel-header"><div class="panel-title">Dica: Dinheiro Parado</div></div>
          <div class="panel-body" id="dinheiro-parado"><div class="fs-12 text-grey">Registre transações para análise.</div></div>
        </div>
        <div class="panel">
          <div class="panel-header"><div class="panel-title">Perguntas Frequentes</div></div>
          <div class="panel-body" style="display:flex;flex-direction:column;gap:6px;">
            <button class="btn btn-ghost btn-full" onclick="setIAPrompt('Qual a melhor estratégia para quitar nossas dívidas mais rápido?')" style="text-align:left;justify-content:flex-start;font-size:11.5px;">Quitar dívidas mais rápido</button>
            <button class="btn btn-ghost btn-full" onclick="setIAPrompt('Como devemos dividir o dinheiro entre investimentos e reserva de emergência?')" style="text-align:left;justify-content:flex-start;font-size:11.5px;">Investimentos vs reserva</button>
            <button class="btn btn-ghost btn-full" onclick="setIAPrompt('Faz sentido dolarizar parte do nosso patrimônio agora?')" style="text-align:left;justify-content:flex-start;font-size:11.5px;">Dolarização do patrimônio</button>
            <button class="btn btn-ghost btn-full" onclick="setIAPrompt('Como posso reduzir os gastos sem perder qualidade de vida?')" style="text-align:left;justify-content:flex-start;font-size:11.5px;">Reduzir gastos com qualidade</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ═══ INVESTIMENTOS ═══ -->
  <div class="page" id="page-investimentos">
    <div class="stat-row stat-row-4 mb-20">
      <div class="stat-card"><div class="stat-label">Total Investido</div><div class="stat-value gold mono" id="inv-tot">R$ 0</div></div>
      <div class="stat-card"><div class="stat-label">Renda Variável</div><div class="stat-value blue mono" id="inv-rv">R$ 0</div></div>
      <div class="stat-card"><div class="stat-label">Renda Fixa</div><div class="stat-value green mono" id="inv-rf">R$ 0</div></div>
      <div class="stat-card"><div class="stat-label">Exterior</div><div class="stat-value mono" id="inv-ext">R$ 0</div></div>
    </div>
    <div class="panel-row pr2">
      <div class="panel">
        <div class="panel-header"><div class="panel-title">Adicionar Ativo</div></div>
        <div class="panel-body">
          <div class="form-grid fg2" style="gap:11px;">
            <div class="field"><label>Ticker / Nome</label><input id="inv-ticker" placeholder="PETR4, TESOURO SELIC..."></div>
            <div class="field"><label>Classe</label><select id="inv-classe"><option>Ação B3</option><option>FII</option><option>ETF Nacional</option><option>Tesouro Direto</option><option>CDB / LCI / LCA</option><option>BDR (Exterior)</option><option>Dólar / Câmbio</option><option>Criptomoeda</option></select></div>
            <div class="field"><label>Valor (R$)</label><input id="inv-valor" type="number" placeholder="0.00"></div>
            <div class="field"><label>Quantidade</label><input id="inv-qtd" type="number" placeholder="0"></div>
          </div>
          <button class="btn btn-gold btn-full mt-16" onclick="saveInv()">Adicionar</button>
        </div>
      </div>
      <div class="panel">
        <div class="panel-header"><div class="panel-title">Sugestões de Alocação</div></div>
        <div class="panel-body" style="display:flex;flex-direction:column;gap:8px;">
          <div class="tx-item" style="padding:7px 0;"><div class="tx-dot" style="background:var(--green);"></div><div class="tx-info"><div class="tx-desc">Tesouro Selic</div><div class="tx-meta">Reserva de emergência — liquidez diária</div></div></div>
          <div class="tx-item" style="padding:7px 0;"><div class="tx-dot" style="background:var(--blue);"></div><div class="tx-info"><div class="tx-desc">FIIs — MXRF11, KNRI11</div><div class="tx-meta">Renda passiva mensal via imóveis</div></div></div>
          <div class="tx-item" style="padding:7px 0;"><div class="tx-dot" style="background:var(--amber);"></div><div class="tx-info"><div class="tx-desc">IVVB11 (S&P 500)</div><div class="tx-meta">Dolarização via B3 — mercado americano</div></div></div>
          <div class="tx-item" style="padding:7px 0;border-bottom:none;"><div class="tx-dot" style="background:var(--gold);"></div><div class="tx-info"><div class="tx-desc">BDRs — AAPL34, MSFT34</div><div class="tx-meta">Exposição ao exterior com praticidade</div></div></div>
        </div>
      </div>
    </div>
    <div class="panel"><div class="panel-header"><div class="panel-title">Carteira</div></div><div class="tbl-wrap"><table><thead><tr><th>Ativo</th><th>Classe</th><th>Valor</th><th>Qtd</th><th>Tipo</th><th>Ação</th></tr></thead><tbody id="inv-tbody"><tr><td colspan="6" style="text-align:center;padding:20px;color:var(--grey2);">Nenhum ativo.</td></tr></tbody></table></div></div>
  </div>

  <!-- ═══ RELATÓRIO MENSAL ═══ -->
  <div class="page" id="page-relatorio">
    <div id="fechar-mes-card" class="mes-card">
      <div class="flex-between mb-12">
        <div>
          <div style="font-size:12px;letter-spacing:1.5px;text-transform:uppercase;color:var(--gold);margin-bottom:4px;">Disponível</div>
          <div style="font-family:'Playfair Display',serif;font-size:20px;">Fechar o Mês — <span id="mes-ref"></span></div>
        </div>
        <button class="btn btn-gold" id="btn-fechar-mes" onclick="fecharMes()">Fechar Mês</button>
      </div>
      <div class="fs-12 text-grey">Gera o relatório completo do mês anterior com análise de IA, indicadores e plano de ação.</div>
    </div>

    <div id="relatorio-body">
      <div class="panel mb-16">
        <div class="panel-header"><div class="panel-title">Relatório Mensal</div></div>
        <div class="panel-body">
          <div class="fs-12 text-grey" style="line-height:1.8;" id="rel-content">
            O botão "Fechar o Mês" aparece no dia 1º de cada mês com o relatório do mês anterior.<br>
            Continue registrando suas transações diariamente para uma análise completa.
          </div>
          <div id="rel-buttons" style="display:none;margin-top:16px;display:flex;gap:8px;">
            <button class="btn btn-gold" id="btn-baixar-rel" onclick="baixarRelatorio()">Baixar Relatório PDF</button>
            <button class="btn btn-ghost" onclick="exportCSV()">Exportar CSV</button>
          </div>
        </div>
      </div>
      <div class="panel-row pr2">
        <div class="panel"><div class="panel-header"><div class="panel-title">Indicadores do Mês</div></div><div class="panel-body" id="rel-indicadores"><div class="fs-12 text-grey">Sem dados.</div></div></div>
        <div class="panel"><div class="panel-header"><div class="panel-title">Limite de Gastos por Categoria</div></div><div class="panel-body" id="rel-limites"><div class="fs-12 text-grey">Disponível após 1 mês de registros.</div></div></div>
      </div>
    </div>
  </div>

</div><!-- /main -->
</div><!-- /shell -->

<div class="toast" id="toast"><div class="toast-dot"></div><span id="toast-msg">Salvo.</span></div>

<script>
// ═══════ STATE ═══════
const LSKEY = 'patrimonio_v3';
function loadS() {
  try { const s = localStorage.getItem(LSKEY); if(s) return JSON.parse(s); } catch(e){}
  return { profile:'diego', lancamentos:[], dividas:[], metas:[], banks:[], investimentos:[], empadas:[], laromme:[], recorrentes:[], relFechado:{} };
}
function saveS() { try { localStorage.setItem(LSKEY, JSON.stringify(S)); } catch(e){} }
const S = loadS();

// ═══════ CATEGORY TREES ═══════
const CAT_E = [{id:'salario',label:'Salário / Renda PJ'},{id:'freelance',label:'Freelance'},{id:'rendimentos',label:'Rendimentos'},{id:'outros_e',label:'Outros'}];
const CAT_S = [
  {id:'moradia',label:'Moradia',children:[{id:'aluguel',label:'Aluguel'},{id:'condominio',label:'Condomínio'},{id:'agua',label:'Água'},{id:'luz',label:'Luz'},{id:'internet',label:'Internet'},{id:'manut',label:'Manutenção'}]},
  {id:'alimentacao',label:'Alimentação',children:[{id:'mercado',label:'Supermercado'},{id:'restaurante',label:'Restaurante'},{id:'delivery',label:'Delivery'},{id:'padaria',label:'Padaria / Café'}]},
  {id:'transporte',label:'Transporte',children:[{id:'combustivel',label:'Combustível'},{id:'uber',label:'Uber / 99'},{id:'metro',label:'Metrô / Ônibus'},{id:'estac',label:'Estacionamento'},{id:'manut_car',label:'Manutenção Carro'}]},
  {id:'assinaturas',label:'Assinaturas',children:[
    {id:'streaming',label:'Streaming',children:[{id:'netflix',label:'Netflix'},{id:'spotify',label:'Spotify'},{id:'disney',label:'Disney+'},{id:'prime',label:'Prime Video'},{id:'hbo',label:'Max'},{id:'outro_str',label:'Outro',custom:true}]},
    {id:'saude_ass',label:'Saúde & Bem-estar',children:[{id:'academia',label:'Academia'},{id:'plano',label:'Plano de Saúde'},{id:'outro_sau',label:'Outro',custom:true}]},
    {id:'software',label:'Software',children:[{id:'adobe',label:'Adobe'},{id:'outro_sw',label:'Outro',custom:true}]},
    {id:'outra_ass',label:'Outra',custom:true}
  ]},
  {id:'saude',label:'Saúde',children:[{id:'consulta',label:'Consulta'},{id:'farmacia',label:'Farmácia'},{id:'exame',label:'Exame'}]},
  {id:'educacao',label:'Educação',children:[{id:'curso',label:'Curso'},{id:'livro',label:'Livros'},{id:'outro_edu',label:'Outro',custom:true}]},
  {id:'lazer',label:'Lazer',children:[{id:'viagem',label:'Viagem'},{id:'cinema',label:'Cinema / Teatro'},{id:'roupas',label:'Roupas'},{id:'presente',label:'Presente'},{id:'outro_laz',label:'Outro',custom:true}]},
  {id:'divida',label:'Dívida / Parcela',children:[{id:'cartao',label:'Cartão de Crédito'},{id:'emprest',label:'Empréstimo'},{id:'financ',label:'Financiamento'},{id:'outro_div',label:'Outro',custom:true}]},
  {id:'projeto',label:'Projetos',children:[
    {id:'proj_emp',label:'Empadas da Dinha',children:[{id:'emp_ins',label:'Insumos',children:[{id:'emp_far',label:'Farinha'},{id:'emp_fra',label:'Frango'},{id:'emp_quei',label:'Queijo'},{id:'emp_emb',label:'Embalagem'},{id:'emp_outro',label:'Outro',custom:true}]},{id:'emp_equip',label:'Equipamento'},{id:'emp_mkt',label:'Divulgação'}]},
    {id:'proj_lar',label:'Laromme',children:[{id:'lar_mp',label:'Matéria-prima',children:[{id:'lar_tec',label:'Tecido'},{id:'lar_eti',label:'Etiqueta'},{id:'lar_emb',label:'Embalagem'},{id:'lar_outro',label:'Outro',custom:true}]},{id:'lar_prod',label:'Produção',children:[{id:'lar_cos',label:'Costura'},{id:'lar_est',label:'Estamparia'},{id:'lar_op',label:'Outro',custom:true}]},{id:'lar_mkt',label:'Marketing',children:[{id:'lar_foto',label:'Fotografia'},{id:'lar_soc',label:'Redes Sociais'},{id:'lar_om',label:'Outro',custom:true}]}]}
  ]},
  {id:'outros',label:'Outros',custom:true}
];
const CAT_EMP_C = [{id:'ins',label:'Insumos',children:[{id:'far',label:'Farinha'},{id:'fra',label:'Frango'},{id:'quei',label:'Queijo'},{id:'emb',label:'Embalagem'},{id:'out',label:'Outro',custom:true}]},{id:'equip',label:'Equipamento'},{id:'mkt',label:'Divulgação'},{id:'out2',label:'Outro',custom:true}];
const CAT_LAR_I = [{id:'mp',label:'Matéria-prima',children:[{id:'tec',label:'Tecido'},{id:'eti',label:'Etiqueta'},{id:'emb',label:'Embalagem'},{id:'out',label:'Outro',custom:true}]},{id:'prod',label:'Produção',children:[{id:'cos',label:'Costura'},{id:'est',label:'Estamparia'},{id:'op',label:'Outro',custom:true}]},{id:'mkt',label:'Marketing',children:[{id:'foto',label:'Fotografia'},{id:'soc',label:'Redes Sociais'},{id:'om',label:'Outro',custom:true}]},{id:'out2',label:'Outro',custom:true}];
const CAT_LAR_R = [{id:'venda',label:'Venda'},{id:'out',label:'Outro',custom:true}];

// ═══════ CAT TREE RENDERER ═══════
const _trees = {};
function buildTree(containerId, crumbId, hiddenId, tree, path=[]) {
  if (tree) _trees[containerId] = tree;
  const src = _trees[containerId] || [];
  const container = document.getElementById(containerId);
  const crumb = document.getElementById(crumbId);
  if (!container) return;
  function getNode(p) {
    let n = {children:src};
    for(const s of p) { n=(n.children||[]).find(c=>c.id===s); if(!n) return null; }
    return n;
  }
  const node = getNode(path);
  const items = node ? node.children : src;
  if(path.length===0){crumb.style.display='none';crumb.innerHTML='';}
  else{
    crumb.style.display='flex';
    const labels=['Início'];
    let n={children:src};
    for(const s of path){n=(n.children||[]).find(c=>c.id===s);if(n)labels.push(n.label);}
    crumb.innerHTML=labels.map((l,i)=>i<labels.length-1?`<span style="cursor:pointer;color:var(--grey2);" onclick="buildTree('${containerId}','${crumbId}','${hiddenId}',null,${JSON.stringify(path.slice(0,i))})">${l}</span><span style="color:var(--grey2);"> / </span>`:`<span>${l}</span>`).join('');
  }
  let html='';
  if(path.length>0) html+=`<button class="cat-back" onclick="buildTree('${containerId}','${crumbId}','${hiddenId}',null,${JSON.stringify(path.slice(0,-1))})">&#8592; Voltar</button>`;
  html+='<div class="cat-grid">';
  for(const it of (items||[])){
    if(it.children&&it.children.length) html+=`<button class="cat-opt" onclick="buildTree('${containerId}','${crumbId}','${hiddenId}',null,${JSON.stringify([...path,it.id])})">${it.label} ›</button>`;
    else if(it.custom) html+=`<button class="cat-opt" onclick="catCustom('${hiddenId}','${it.label}')">${it.label}</button>`;
    else html+=`<button class="cat-opt" id="copt-${containerId}-${it.id}" onclick="catSel('${containerId}','${hiddenId}','${it.id}','${it.label}')">${it.label}</button>`;
  }
  html+='</div>';
  container.innerHTML=html;
}
function catSel(cid, hid, id, label){
  document.getElementById(hid).value=label;
  document.querySelectorAll(`#${cid} .cat-opt`).forEach(b=>b.classList.remove('selected'));
  const el=document.getElementById(`copt-${cid}-${id}`);
  if(el) el.classList.add('selected');
}
function catCustom(hid, label){
  const n=prompt(`Nome para "${label}":`);
  if(n){document.getElementById(hid).value=n;showToast('Categoria personalizada definida.');}
}

// ═══════ UTILS ═══════
const fmt=v=>'R$\u00a0'+Number(v||0).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});
const today=()=>new Date().toISOString().split('T')[0];
function showToast(msg){document.getElementById('toast-msg').textContent=msg;const t=document.getElementById('toast');t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3200);}
function toggleEl(id){const el=document.getElementById(id);el.style.display=el.style.display==='none'?'block':'none';}
function setDate(){
  const now=new Date();
  document.getElementById('top-date').textContent=now.toLocaleDateString('pt-BR',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
  document.getElementById('db-month').textContent=now.toLocaleDateString('pt-BR',{month:'short',year:'numeric'}).toUpperCase();
  ['l-data','emp-data','lar-data'].forEach(id=>{const el=document.getElementById(id);if(el&&!el.value)el.value=today();});
  checkFecharMes();
}

// ═══════ NAV ═══════
const pageTitles={dashboard:'Dashboard',consolidado:'Visão do Casal',calendario:'Calendário Financeiro',alertas:'Alertas',lancamentos:'Lançamentos',recorrentes:'Contas Fixas',dividas:'Dívidas',metas:'Metas & Objetivos',simulador:'Simulador de Compra',contas:'Contas & Bancos',empadas:'Empadas da Dinha',laromme:'Laromme',central:'Central do Dinheiro',investimentos:'Carteira de Investimentos',relatorio:'Relatório Mensal'};
function go(id, btn){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-'+id).classList.add('active');
  if(btn&&btn.classList) btn.classList.add('active');
  document.getElementById('top-title').textContent=pageTitles[id]||id;
  if(id==='consolidado') renderConsolidado();
  if(id==='calendario') renderCalendario();
  if(id==='alertas') renderAlertas();
  if(id==='relatorio') renderRelatorio();
  if(id==='central') renderDinheiroPara();
}
function setProfile(p,btn){
  S.profile=p;
  document.querySelectorAll('.profile-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('top-profile').textContent=p==='diego'?'Diego':'Dinha';
  saveS(); renderAll(); updateDashboard();
}

// ═══════ LANCAMENTOS ═══════
let lancTipo='entrada';
function setLancTipo(t){
  lancTipo=t;
  document.getElementById('tab-e').classList.toggle('active',t==='entrada');
  document.getElementById('tab-s').classList.toggle('active',t==='saida');
  buildTree('cat-tree','cat-breadcrumb','cat-selected',t==='entrada'?CAT_E:CAT_S,[]);
}
async function saveLanc(){
  const desc=document.getElementById('l-desc').value.trim();
  const valor=parseFloat(document.getElementById('l-valor').value);
  const data=document.getElementById('l-data').value;
  const owner=document.getElementById('l-owner').value;
  const nat=document.getElementById('l-nat').value;
  const cat=document.getElementById('cat-selected').value||'(sem categoria)';
  if(!desc||!valor) return showToast('Preencha descrição e valor.');
  const item={id:Date.now(),desc,valor,data,owner,nat,cat,tipo:lancTipo,ts:new Date().getHours()};
  if(window._firebase&&window._firebase.useFirebase){await window._saveToFirebase('lancamentos',item);}
  else{S.lancamentos.push(item);saveS();}
  document.getElementById('l-desc').value='';document.getElementById('l-valor').value='';document.getElementById('cat-selected').value='';
  buildTree('cat-tree','cat-breadcrumb','cat-selected',lancTipo==='entrada'?CAT_E:CAT_S,[]);
  renderLancamentos();updateDashboard();showToast('Lançamento registrado.');
}
function renderLancamentos(){
  const c=document.getElementById('lanc-list');
  const items=filterByProfile(S.lancamentos).slice().reverse().slice(0,50);
  if(!items.length){c.innerHTML='<div class="fs-12 text-grey">Nenhum lançamento.</div>';return;}
  c.innerHTML=items.map(l=>`<div class="tx-item"><div class="tx-dot" style="background:${l.tipo==='entrada'?'var(--green)':'var(--red)'};"></div><div class="tx-info"><div class="tx-desc">${l.desc}</div><div class="tx-meta">${l.cat} · ${l.nat} · ${l.owner}</div></div><div style="text-align:right;"><div class="tx-val ${l.tipo==='entrada'?'text-green':'text-red'}">${l.tipo==='entrada'?'+':'-'}${fmt(l.valor)}</div><div class="tx-date">${l.data}</div></div></div>`).join('');
}

// ═══════ FILTER ═══════
function filterByProfile(arr){return arr.filter(x=>x.owner===S.profile||(S.profile==='diego'&&x.owner==='Diego')||(S.profile==='dinha'&&x.owner==='Dinha'));}
function allItems(arr){return arr;}

// ═══════ DASHBOARD ═══════
function updateDashboard(){
  const items=filterByProfile(S.lancamentos);
  const entradas=items.filter(l=>l.tipo==='entrada').reduce((a,l)=>a+l.valor,0);
  const saidas=items.filter(l=>l.tipo==='saida').reduce((a,l)=>a+l.valor,0);
  const saldo=entradas-saidas;
  const invest=entradas*0.20;
  const taxa=entradas>0?((saidas/entradas)*100).toFixed(0):0;
  document.getElementById('s-renda').textContent=fmt(entradas);
  document.getElementById('s-gastos').textContent=fmt(saidas);
  document.getElementById('s-saldo').textContent=fmt(saldo);
  document.getElementById('s-invest').textContent=fmt(invest);
  document.getElementById('s-taxa').textContent=`${taxa}% da renda`;

  // Bars
  const max=Math.max(entradas,1);
  const h=(v)=>Math.min((v/max)*110,110);
  const divP=filterByProfile(S.dividas).reduce((a,d)=>a+d.parcela,0);
  document.getElementById('bc-nec').style.height=h(entradas*0.5)+'px';document.getElementById('bc-nec-v').textContent=fmt(entradas*0.5);
  document.getElementById('bc-des').style.height=h(entradas*0.3)+'px';document.getElementById('bc-des-v').textContent=fmt(entradas*0.3);
  document.getElementById('bc-inv').style.height=h(invest)+'px';document.getElementById('bc-inv-v').textContent=fmt(invest);
  document.getElementById('bc-div').style.height=h(divP)+'px';document.getElementById('bc-div-v').textContent=fmt(divP);

  // AI insights
  generateAI(items,entradas,saidas);

  // Saldo livre tip
  const tip=document.getElementById('saldo-tip');
  if(saldo>500&&entradas>0){
    const divTot=filterByProfile(S.dividas).reduce((a,d)=>a+d.total,0);
    let msg=`Você possui <strong>${fmt(saldo)}</strong> de saldo disponível. `;
    if(divTot>0) msg+=`Considere adiantar parcelas de dívidas (economiza juros) ou aplicar em Tesouro Selic enquanto não usa.`;
    else msg+=`Ótimo momento para reforçar investimentos ou acelerar o progresso de uma meta.`;
    tip.innerHTML=msg;tip.style.display='block';
  } else {tip.style.display='none';}

  // Torneira
  const banner=document.getElementById('torneira-banner');
  if(entradas>0&&taxa>85){banner.innerHTML=`<strong>Fechar a Torneira —</strong> Seus gastos atingiram ${taxa}% da renda. Limite seguro é 80%. Pause gastos não essenciais imediatamente.`;banner.style.display='block';}
  else{banner.style.display='none';}

  // DB Metas
  const mts=S.metas.slice(0,3);
  document.getElementById('db-metas').innerHTML=mts.length?mts.map(m=>{const pct=Math.min((m.atual/m.total)*100,100).toFixed(0);return`<div class="prog-wrap"><div class="prog-header"><span>${m.nome}</span><span class="prog-pct">${pct}%</span></div><div class="prog-bar"><div class="prog-fill fill-gold" style="width:${pct}%"></div></div><div class="fs-11 text-grey" style="margin-top:3px;">${fmt(m.atual)} de ${fmt(m.total)}</div></div>`;}).join(''):'<div class="fs-12 text-grey">Nenhuma meta.</div>';

  // DB TX
  const txAll=filterByProfile(S.lancamentos).slice().reverse().slice(0,5);
  document.getElementById('db-tx').innerHTML=txAll.length?txAll.map(l=>`<div class="tx-item"><div class="tx-dot" style="background:${l.tipo==='entrada'?'var(--green)':'var(--red)'};"></div><div class="tx-info"><div class="tx-desc">${l.desc}</div><div class="tx-meta">${l.cat} · ${l.owner}</div></div><div style="text-align:right;"><div class="tx-val ${l.tipo==='entrada'?'text-green':'text-red'}">${l.tipo==='entrada'?'+':'-'}${fmt(l.valor)}</div><div class="tx-date">${l.data}</div></div></div>`).join(''):'<div class="fs-12 text-grey" style="padding:12px 0;">Nenhum lançamento ainda.</div>';

  // Alertas no dashboard
  checkAlertas();
}

function generateAI(items,entradas,saidas){
  const c=document.getElementById('ai-items');
  if(!entradas){c.innerHTML='<div class="fs-12 text-grey">Registre transações para ativar.</div>';return;}
  const taxa=saidas/entradas;const ins=[];
  if(taxa>0.85) ins.push({col:'var(--red)',t:`Gastos em ${(taxa*100).toFixed(0)}% da renda — acima do limite seguro de 80%.`});
  else if(taxa>0.65) ins.push({col:'var(--amber)',t:`Gastos em ${(taxa*100).toFixed(0)}% da renda. Margem para investir está apertada.`});
  else ins.push({col:'var(--green)',t:`Gastos em ${(taxa*100).toFixed(0)}% da renda. Situação saudável. Direcione o excedente.`});
  const assins=items.filter(l=>l.cat&&l.cat.toLowerCase().includes('streaming')&&l.tipo==='saida');
  if(assins.length){const tot=assins.reduce((a,l)=>a+l.valor,0);ins.push({col:'var(--amber)',t:`${fmt(tot)}/mês em streaming. Revise o que realmente usa.`});}
  const divTot=S.dividas.reduce((a,d)=>a+d.total,0);
  if(divTot>0&&entradas>0){const m=Math.ceil(divTot/(entradas*0.30));ins.push({col:'var(--blue)',t:`Com 30% da renda nas dívidas, quita tudo em ~${m} meses. Priorize as de maior juros.`});}
  ins.push({col:'var(--gold)',t:`Reserve ${fmt(entradas*0.20)}/mês em investimentos. Comece pelo Tesouro Selic para a reserva de emergência.`});
  c.innerHTML=ins.map(i=>`<div style="display:flex;gap:8px;align-items:flex-start;padding:7px 0;border-bottom:1px solid var(--border2);"><div style="width:5px;height:5px;border-radius:50%;background:${i.col};flex-shrink:0;margin-top:5px;"></div><div class="fs-12 text-grey">${i.t}</div></div>`).join('');
}

// ═══════ CONTAS FIXAS / RECORRENTES ═══════
async function saveRecorrente(){
  const desc=document.getElementById('rec-desc').value.trim();
  const valor=parseFloat(document.getElementById('rec-valor').value);
  const dia=parseInt(document.getElementById('rec-dia').value);
  const cat=document.getElementById('rec-cat').value;
  const owner=document.getElementById('rec-owner').value;
  const alert=parseInt(document.getElementById('rec-alert').value);
  if(!desc||!valor||!dia) return showToast('Preencha todos os campos.');
  const item={id:Date.now(),desc,valor,dia,cat,owner,alert};
  if(window._firebase&&window._firebase.useFirebase) await window._saveToFirebase('recorrentes',item);
  else{S.recorrentes.push(item);saveS();}
  ['rec-desc','rec-valor','rec-dia'].forEach(i=>document.getElementById(i).value='');
  renderRecorrentes();checkAlertas();showToast('Conta fixa cadastrada.');
}
function renderRecorrentes(){
  const c=document.getElementById('rec-list');
  if(!S.recorrentes.length){c.innerHTML='<div class="fs-12 text-grey">Nenhuma conta fixa.</div>';return;}
  c.innerHTML=S.recorrentes.map(r=>`<div class="tx-item"><div class="tx-dot" style="background:var(--amber);"></div><div class="tx-info"><div class="tx-desc">${r.desc}</div><div class="tx-meta">Todo dia ${r.dia} · ${r.cat} · ${r.owner}</div></div><div style="text-align:right;"><div class="tx-val text-red">${fmt(r.valor)}</div><button class="btn btn-danger btn-sm" style="margin-top:4px;" onclick="removeRec(${r.id})">Remover</button></div></div>`).join('');
}
function removeRec(id){S.recorrentes=S.recorrentes.filter(r=>r.id!==id);saveS();renderRecorrentes();checkAlertas();}

// ═══════ ALERTAS ═══════
function checkAlertas(){
  const now=new Date();const dia=now.getDate();
  const alertas=[];
  S.recorrentes.forEach(r=>{
    if(r.alert===0) return;
    const diasAte=r.dia>=dia?r.dia-dia:30-(dia-r.dia);
    let urgencia='ok';
    if(diasAte===0) urgencia='urgent';
    else if(diasAte<=5) urgencia='urgent';
    else if(diasAte<=15) urgencia='soon';
    else return;
    alertas.push({...r,diasAte,urgencia});
  });
  const badge=document.getElementById('alertas-badge');
  if(alertas.length>0){badge.textContent=alertas.length;badge.style.display='inline';}
  else{badge.style.display='none';}
  const dbAl=document.getElementById('db-alertas');
  if(!alertas.length){dbAl.innerHTML='<div class="fs-12 text-grey">Nenhum alerta próximo.</div>';return;}
  dbAl.innerHTML=alertas.slice(0,3).map(a=>`<div class="alert-card ${a.urgencia}"><div class="alert-dot-lg" style="background:${a.urgencia==='urgent'?'var(--red)':'var(--amber)'};"></div><div class="alert-body"><div class="alert-name">${a.desc}</div><div class="alert-sub">Vence dia ${a.dia} · ${a.diasAte===0?'Hoje!':a.diasAte+' dias'}</div></div><div class="alert-val ${a.urgencia==='urgent'?'text-red':'text-amber'}">${fmt(a.valor)}</div></div>`).join('');
}
function renderAlertas(){
  const now=new Date();const dia=now.getDate();
  const urgentes=[],proximais=[],ok=[];
  S.recorrentes.forEach(r=>{
    const diasAte=r.dia>=dia?r.dia-dia:30-(dia-r.dia);
    if(diasAte===0||diasAte<=5) urgentes.push({...r,diasAte});
    else if(diasAte<=15) proximais.push({...r,diasAte});
    else ok.push({...r,diasAte});
  });
  const mkCard=(a)=>`<div class="alert-card ${a.diasAte<=5?'urgent':'soon'}"><div class="alert-dot-lg" style="background:${a.diasAte<=5?'var(--red)':'var(--amber)'};"></div><div class="alert-body"><div class="alert-name">${a.desc}</div><div class="alert-sub">Vence dia ${a.dia} · ${a.diasAte===0?'Hoje!':a.diasAte+' dias'} · ${a.cat} · ${a.owner}</div></div><div class="alert-val text-red">${fmt(a.valor)}</div></div>`;
  const mkOk=(a)=>`<div class="alert-card ok"><div class="alert-dot-lg" style="background:var(--green);"></div><div class="alert-body"><div class="alert-name">${a.desc}</div><div class="alert-sub">Vence dia ${a.dia} · ${a.diasAte} dias · ${a.owner}</div></div><div class="alert-val text-grey">${fmt(a.valor)}</div></div>`;
  let html='';
  if(urgentes.length){html+=`<div class="stat-label" style="margin-bottom:10px;color:var(--red);">Urgente — Hoje / Próximos 5 dias</div>${urgentes.map(mkCard).join('')}<div class="divider"></div>`;}
  if(proximais.length){html+=`<div class="stat-label" style="margin-bottom:10px;color:var(--amber);">Em breve — Próximos 15 dias</div>${proximais.map(mkCard).join('')}<div class="divider"></div>`;}
  if(ok.length){html+=`<div class="stat-label" style="margin-bottom:10px;">Contas do Mês</div>${ok.map(mkOk).join('')}`;}
  document.getElementById('alertas-list').innerHTML=html||'<div class="fs-12 text-grey">Nenhuma conta fixa cadastrada. Vá em "Contas Fixas" para configurar alertas.</div>';
  const total=urgentes.reduce((a,r)=>a+r.valor,0)+proximais.reduce((a,r)=>a+r.valor,0);
  document.getElementById('alertas-urgentes').innerHTML=urgentes.length||proximais.length?`<div style="padding:12px 14px;border-radius:6px;border:1px solid var(--gold-br);background:var(--gold-bg);font-size:12px;color:var(--gold2);margin-bottom:16px;">Atenção: ${fmt(total)} em contas a vencer nos próximos 15 dias. Garanta o saldo disponível.</div>`:'';
}

// ═══════ DÍVIDAS ═══════
async function saveDivida(){
  const desc=document.getElementById('d-desc').value.trim();
  const total=parseFloat(document.getElementById('d-total').value);
  const parcela=parseFloat(document.getElementById('d-parcela').value)||0;
  const juros=parseFloat(document.getElementById('d-juros').value)||0;
  const owner=document.getElementById('d-owner').value;
  if(!desc||!total) return showToast('Preencha os campos obrigatórios.');
  const item={id:Date.now(),desc,total,parcela,juros,owner};
  if(window._firebase&&window._firebase.useFirebase) await window._saveToFirebase('dividas',item);
  else{S.dividas.push(item);saveS();}
  ['d-desc','d-total','d-parcela','d-juros'].forEach(i=>document.getElementById(i).value='');
  renderDividas();updateDashboard();showToast('Dívida cadastrada.');
}
function renderDividas(){
  const items=S.dividas;
  const tot=items.reduce((a,d)=>a+d.total,0);
  const parc=items.reduce((a,d)=>a+d.parcela,0);
  document.getElementById('d-sum').textContent=fmt(tot);
  document.getElementById('d-prazo').textContent=parc>0?Math.ceil(tot/parc)+' meses':'—';
  const c=document.getElementById('dividas-list');
  if(!items.length){c.innerHTML='<div class="fs-12 text-grey">Nenhuma dívida.</div>';return;}
  c.innerHTML=items.map(d=>{const m=d.parcela>0?Math.ceil(d.total/d.parcela):'?';return`<div style="padding:12px 0;border-bottom:1px solid var(--border2);"><div style="display:flex;justify-content:space-between;align-items:flex-start;"><div><div class="fs-13 text-white" style="font-weight:500;">${d.desc}</div><div class="fs-11 text-grey" style="margin-top:3px;">${fmt(d.parcela)}/mês · ${m} meses · ${d.juros}% a.m. · ${d.owner}</div></div><div style="text-align:right;"><div class="tx-val text-red">${fmt(d.total)}</div><button class="btn btn-danger btn-sm" style="margin-top:4px;" onclick="removeDivida(${d.id})">Remover</button></div></div></div>`;}).join('');
}
function removeDivida(id){S.dividas=S.dividas.filter(d=>d.id!==id);saveS();renderDividas();updateDashboard();}

// ═══════ METAS ═══════
const META_TIPS={
  'Viagem':['Meses com passagens mais baratas variam por destino — pesquise com 3-4 meses de antecedência.','Viagem para Argentina: melhor entre março e maio (temporada baixa, câmbio favorável).','Use milhas para reduzir o custo das passagens — considere um cartão com programa de pontos.'],
  'Casamento':['Casamentos em dia de semana podem ser até 30% mais baratos.','Buffets fecham contratos com antecedência de 12-18 meses — reserve cedo para melhores preços.','Planeje uma reserva de 10-15% extra para imprevistos do evento.'],
  'Carro':['Carros seminovos com 1-2 anos custam ~25% menos que o zero km com depreciação já absorvida.','Avalie o custo total: IPVA, seguro e manutenção podem representar 15-20% do valor do carro por ano.'],
  'Imóvel':['Com boa reserva, você pode negociar desconto à vista de 5-15% mesmo em financiamentos.','O FGTS do Diego pode ser usado na compra do primeiro imóvel — verifique o saldo.'],
  'Reserva de Emergência':['Ideal: 6 meses de renda familiar. No seu caso, a meta seria em torno de R$50.000.','Mantenha a reserva em Tesouro Selic ou CDB com liquidez diária — não poupança.'],
  'Outro':['Automatize o aporte mensal para garantir disciplina — transfira logo após o salário cair.','Acompanhe o progresso mensalmente e ajuste o aporte se a renda aumentar.']
};
async function saveMeta(){
  const nome=document.getElementById('m-nome').value.trim();
  const total=parseFloat(document.getElementById('m-total').value);
  const atual=parseFloat(document.getElementById('m-atual').value)||0;
  const aporte=parseFloat(document.getElementById('m-aporte').value)||0;
  const owner=document.getElementById('m-owner').value;
  const tipo=document.getElementById('m-tipo').value;
  if(!nome||!total) return showToast('Preencha nome e valor total.');
  const item={id:Date.now(),nome,total,atual,aporte,owner,tipo};
  if(window._firebase&&window._firebase.useFirebase) await window._saveToFirebase('metas',item);
  else{S.metas.push(item);saveS();}
  ['m-nome','m-total','m-atual','m-aporte'].forEach(i=>document.getElementById(i).value='');
  renderMetas();updateDashboard();showToast('Meta adicionada.');
}
function renderMetas(){
  const c=document.getElementById('metas-list');
  if(!S.metas.length){c.innerHTML='<div class="panel"><div class="panel-body"><div class="fs-12 text-grey">Nenhuma meta.</div></div></div>';return;}
  c.innerHTML=S.metas.map(m=>{
    const pct=Math.min((m.atual/m.total)*100,100).toFixed(1);
    const meses=m.aporte>0?Math.ceil((m.total-m.atual)/m.aporte):null;
    const tips=META_TIPS[m.tipo]||META_TIPS['Outro'];
    const tip=tips[Math.floor(Math.random()*tips.length)];
    return`<div class="goal-card"><div class="goal-name">${m.nome}</div><div class="goal-target">Meta: ${fmt(m.total)} · ${m.owner}</div><div class="goal-cur">${fmt(m.atual)}</div><div class="prog-bar"><div class="prog-fill fill-gold" style="width:${pct}%"></div></div><div class="goal-eta">${pct}% concluído${meses?` · ~${meses} meses para atingir`:''}</div><div class="goal-tip">Dica: ${tip}</div></div>`;
  }).join('');
}

// ═══════ BANKS ═══════
async function saveBank(){
  const nome=document.getElementById('b-nome').value.trim();
  const tipo=document.getElementById('b-tipo').value;
  const saldo=parseFloat(document.getElementById('b-saldo').value)||0;
  const owner=document.getElementById('b-owner').value;
  if(!nome) return showToast('Informe o nome da instituição.');
  const item={id:Date.now(),nome,tipo,saldo,owner};
  if(window._firebase&&window._firebase.useFirebase) await window._saveToFirebase('banks',item);
  else{S.banks.push(item);saveS();}
  document.getElementById('b-nome').value='';document.getElementById('b-saldo').value='';
  toggleEl('bank-form');renderBanks();showToast('Conta adicionada.');
}
function renderBanks(){
  const c=document.getElementById('banks-grid');
  if(!S.banks.length){c.innerHTML='<div class="bank-card"><div class="bank-inst">Nenhuma conta cadastrada</div><div class="bank-bal text-grey" style="font-size:14px;margin:8px 0;">Clique em "+ Adicionar Conta"</div></div>';return;}
  const cols={Diego:'var(--blue)',Dinha:'var(--green)',Casal:'var(--gold)'};
  c.innerHTML=S.banks.map(b=>`<div class="bank-card"><div style="position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,${cols[b.owner]||'var(--gold)'},transparent);"></div><div class="bank-inst">${b.nome} — ${b.tipo}</div><div class="bank-bal">${fmt(b.saldo)}</div><div class="bank-meta"><span>${b.owner}</span><button class="btn btn-danger btn-sm" onclick="removeBank(${b.id})">Remover</button></div></div>`).join('');
}
function removeBank(id){S.banks=S.banks.filter(b=>b.id!==id);saveS();renderBanks();}

// ═══════ SIMULADOR ═══════
function runSim(){
  const forma=document.getElementById('sim-forma').value;
  document.getElementById('sim-parc-wrap').style.display=forma==='Crédito parcelado'?'block':'none';
  const valor=parseFloat(document.getElementById('sim-valor').value)||0;
  const desc=document.getElementById('sim-desc').value.trim();
  if(!valor) return;
  const items=filterByProfile(S.lancamentos);
  const entradas=items.filter(l=>l.tipo==='entrada').reduce((a,l)=>a+l.valor,0);
  const saidas=items.filter(l=>l.tipo==='saida').reduce((a,l)=>a+l.valor,0);
  const saldo=entradas-saidas;
  const divTot=S.dividas.reduce((a,d)=>a+d.total,0);
  const numParc=parseInt(document.getElementById('sim-parcelas').value)||1;
  const parcs=forma==='Crédito parcelado'?numParc:1;
  const valorParc=valor/parcs;
  let score=0;const impacts=[];const recs=[];
  if(valor>saldo*0.8){score=Math.max(score,2);impacts.push('Compromete mais de 80% do saldo disponível.');}
  else if(valor>saldo*0.4){score=Math.max(score,1);impacts.push('Compromete mais de 40% do saldo disponível.');}
  if(entradas===0){score=Math.max(score,2);impacts.push('Sem renda registrada — impossível calcular impacto real.');}
  if(divTot>0&&valor>entradas*0.3){score=Math.max(score,2);impacts.push(`Com ${fmt(divTot)} em dívidas ativas, essa compra agrava sua situação.`);}
  else if(divTot>0&&valor>entradas*0.1){score=Math.max(score,1);impacts.push('Com dívidas ativas, avalie priorizar quitação antes de compras grandes.');}
  if(valorParc>entradas*0.1&&forma.includes('parcelado')){score=Math.max(score,1);impacts.push('Parcela representa mais de 10% da renda mensal.');}
  if(forma.includes('Débito')||forma.includes('Pix')){recs.push(valor<=saldo*0.3&&score===0?'Pix à vista é a melhor opção — sem juros ou comprometimento futuro.':'Aguarde acumular o valor sem comprometer o saldo de reserva.');}
  else if(forma.includes('à vista')){recs.push('Negocie desconto à vista (5-10% é comum). Pague a fatura integralmente para evitar juros.');}
  else{const maxSafe=[2,3,4,6,10,12].filter(p=>(valor/p)<entradas*0.1).reverse()[0];recs.push(maxSafe?`Parcele em até ${maxSafe}x para manter o impacto mensal abaixo de 10% da renda.`:'As parcelas comprometeriam muito a renda. Considere guardar o valor e comprar à vista.');}
  const cls=['sim-green','sim-amber','sim-red'];
  const cols=['var(--green)','var(--amber)','var(--red)'];
  const lbls=['Compra Viável','Atenção Necessária','Risco Financeiro'];
  const el=document.getElementById('sim-result');
  el.style.display='block';el.className='sim-result '+cls[score];
  el.innerHTML=`<div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;"><div style="width:9px;height:9px;border-radius:50%;background:${cols[score]};"></div><div style="font-size:13px;font-weight:600;color:${cols[score]};">${lbls[score]}${desc?' — '+desc:''}</div></div><div class="fs-12 text-grey" style="margin-bottom:10px;">Valor: <strong style="color:var(--white);">${fmt(valor)}</strong>${forma.includes('parcelado')?` · ${parcs}x de <strong style="color:var(--white);">${fmt(valorParc)}</strong>`:''} · Saldo atual: <strong style="color:var(--white);">${fmt(saldo)}</strong></div>${impacts.length?`<div style="display:flex;flex-direction:column;gap:5px;margin-bottom:10px;">${impacts.map(i=>`<div style="display:flex;gap:7px;font-size:11.5px;color:var(--grey1);padding:6px 8px;background:rgba(0,0,0,0.2);border-radius:4px;"><span style="color:${cols[score]};">!</span>${i}</div>`).join('')}</div>`:''}<div style="padding:9px 11px;background:var(--gold-bg);border:1px solid var(--gold-br);border-radius:4px;font-size:12px;color:var(--gold2);"><div style="font-size:9px;letter-spacing:1.5px;text-transform:uppercase;margin-bottom:4px;">Recomendação</div>${recs.join(' ')}</div>`;
}

// ═══════ EMPADAS ═══════
let empTipo='receita';
function setEmpTipo(t){
  empTipo=t;
  document.getElementById('emp-tab-r').classList.toggle('active',t==='receita');
  document.getElementById('emp-tab-c').classList.toggle('active',t==='custo');
  document.getElementById('emp-cat-wrap').style.display=t==='custo'?'block':'none';
  if(t==='custo') buildTree('emp-cat-tree','emp-cat-crumb','emp-cat',CAT_EMP_C,[]);
}
async function saveEmpLanc(){
  const desc=document.getElementById('emp-desc').value.trim();
  const valor=parseFloat(document.getElementById('emp-valor').value);
  const data=document.getElementById('emp-data').value;
  const banco=document.getElementById('emp-banco').value.trim();
  const cat=document.getElementById('emp-cat').value||(empTipo==='receita'?'Receita':'Custo');
  if(!desc||!valor) return showToast('Preencha descrição e valor.');
  const item={id:Date.now(),desc,valor,data,banco,cat,tipo:empTipo};
  if(window._firebase&&window._firebase.useFirebase) await window._saveToFirebase('empadas',item);
  else{S.empadas.push(item);saveS();}
  document.getElementById('emp-desc').value='';document.getElementById('emp-valor').value='';document.getElementById('emp-cat').value='';
  renderEmpadas();showToast('Lançado nas Empadas.');
}
function renderEmpadas(){
  const r=S.empadas.filter(l=>l.tipo==='receita').reduce((a,l)=>a+l.valor,0);
  const c=S.empadas.filter(l=>l.tipo==='custo').reduce((a,l)=>a+l.valor,0);
  document.getElementById('emp-r').textContent=fmt(r);document.getElementById('emp-c').textContent=fmt(c);document.getElementById('emp-l').textContent=fmt(r-c);
  const el=document.getElementById('emp-tx');
  el.innerHTML=S.empadas.length?[...S.empadas].reverse().slice(0,20).map(l=>`<div class="tx-item"><div class="tx-dot" style="background:${l.tipo==='receita'?'var(--green)':'var(--red)'};"></div><div class="tx-info"><div class="tx-desc">${l.desc}</div><div class="tx-meta">${l.cat}${l.banco?' · '+l.banco:''} · ${l.data}</div></div><div class="tx-val ${l.tipo==='receita'?'text-green':'text-red'}">${l.tipo==='receita'?'+':'-'}${fmt(l.valor)}</div></div>`).join(''):'<div class="fs-12 text-grey">Nenhum lançamento.</div>';
}

// ═══════ LAROMME ═══════
let larTipo='investimento';
function setLarTipo(t){
  larTipo=t;
  document.getElementById('lar-tab-i').classList.toggle('active',t==='investimento');
  document.getElementById('lar-tab-r').classList.toggle('active',t==='receita');
  buildTree('lar-cat-tree','lar-cat-crumb','lar-cat',t==='investimento'?CAT_LAR_I:CAT_LAR_R,[]);
}
async function saveLarLanc(){
  const desc=document.getElementById('lar-desc').value.trim();
  const valor=parseFloat(document.getElementById('lar-valor').value);
  const data=document.getElementById('lar-data').value;
  const banco=document.getElementById('lar-banco').value.trim();
  const cat=document.getElementById('lar-cat').value||larTipo;
  if(!desc||!valor) return showToast('Preencha descrição e valor.');
  const item={id:Date.now(),desc,valor,data,banco,cat,tipo:larTipo};
  if(window._firebase&&window._firebase.useFirebase) await window._saveToFirebase('laromme',item);
  else{S.laromme.push(item);saveS();}
  document.getElementById('lar-desc').value='';document.getElementById('lar-valor').value='';document.getElementById('lar-cat').value='';
  renderLaromme();showToast('Lançado na Laromme.');
}
function renderLaromme(){
  const inv=S.laromme.filter(l=>l.tipo==='investimento').reduce((a,l)=>a+l.valor,0);
  const r=S.laromme.filter(l=>l.tipo==='receita').reduce((a,l)=>a+l.valor,0);
  document.getElementById('lar-i').textContent=fmt(inv);document.getElementById('lar-r').textContent=fmt(r);document.getElementById('lar-l').textContent=fmt(r-inv);
  const el=document.getElementById('lar-tx');
  el.innerHTML=S.laromme.length?[...S.laromme].reverse().slice(0,20).map(l=>`<div class="tx-item"><div class="tx-dot" style="background:${l.tipo==='receita'?'var(--green)':'var(--blue)'};"></div><div class="tx-info"><div class="tx-desc">${l.desc}</div><div class="tx-meta">${l.cat}${l.banco?' · '+l.banco:''} · ${l.data}</div></div><div class="tx-val ${l.tipo==='receita'?'text-green':'text-blue'}">${l.tipo==='receita'?'+':'-'}${fmt(l.valor)}</div></div>`).join(''):'<div class="fs-12 text-grey">Nenhum lançamento.</div>';
}

// ═══════ INVESTIMENTOS ═══════
async function saveInv(){
  const ticker=document.getElementById('inv-ticker').value.trim().toUpperCase();
  const classe=document.getElementById('inv-classe').value;
  const valor=parseFloat(document.getElementById('inv-valor').value);
  const qtd=parseFloat(document.getElementById('inv-qtd').value)||0;
  if(!ticker||!valor) return showToast('Preencha ticker e valor.');
  const item={id:Date.now(),ticker,classe,valor,qtd};
  if(window._firebase&&window._firebase.useFirebase) await window._saveToFirebase('investimentos',item);
  else{S.investimentos.push(item);saveS();}
  ['inv-ticker','inv-valor','inv-qtd'].forEach(i=>document.getElementById(i).value='');
  renderInv();showToast('Ativo adicionado.');
}
function renderInv(){
  const RV=['Ação B3','FII','ETF Nacional'],RF=['Tesouro Direto','CDB / LCI / LCA'],EXT=['BDR (Exterior)','Dólar / Câmbio','Criptomoeda'];
  const tot=S.investimentos.reduce((a,i)=>a+i.valor,0);
  document.getElementById('inv-tot').textContent=fmt(tot);
  document.getElementById('inv-rv').textContent=fmt(S.investimentos.filter(i=>RV.includes(i.classe)).reduce((a,i)=>a+i.valor,0));
  document.getElementById('inv-rf').textContent=fmt(S.investimentos.filter(i=>RF.includes(i.classe)).reduce((a,i)=>a+i.valor,0));
  document.getElementById('inv-ext').textContent=fmt(S.investimentos.filter(i=>EXT.includes(i.classe)).reduce((a,i)=>a+i.valor,0));
  const tbody=document.getElementById('inv-tbody');
  if(!S.investimentos.length){tbody.innerHTML='<tr><td colspan="6" style="text-align:center;padding:20px;color:var(--grey2);">Nenhum ativo.</td></tr>';return;}
  tbody.innerHTML=S.investimentos.map(i=>{const tipo=RV.includes(i.classe)?'Rend. Var.':RF.includes(i.classe)?'Rend. Fix.':'Exterior';const b=RV.includes(i.classe)?'b-blue':RF.includes(i.classe)?'b-green':'b-gold';return`<tr><td style="color:var(--white);font-weight:500;" class="mono">${i.ticker}</td><td>${i.classe}</td><td class="mono text-gold">${fmt(i.valor)}</td><td class="mono">${i.qtd||'—'}</td><td><span class="badge ${b}">${tipo}</span></td><td><button class="btn btn-danger btn-sm" onclick="removeInv(${i.id})">Remover</button></td></tr>`;}).join('');
}
function removeInv(id){S.investimentos=S.investimentos.filter(i=>i.id!==id);saveS();renderInv();}

// ═══════ CENTRAL IA ═══════
const iaHistory=[];
function setIAPrompt(txt){document.getElementById('ia-input').value=txt;}
function renderDinheiroPara(){
  const items=filterByProfile(S.lancamentos);
  const entradas=items.filter(l=>l.tipo==='entrada').reduce((a,l)=>a+l.valor,0);
  const saidas=items.filter(l=>l.tipo==='saida').reduce((a,l)=>a+l.valor,0);
  const saldo=entradas-saidas;
  const el=document.getElementById('dinheiro-parado');
  if(saldo<=0||entradas===0){el.innerHTML='<div class="fs-12 text-grey">Registre transações para análise.</div>';return;}
  const divTot=S.dividas.reduce((a,d)=>a+d.total,0);
  let html=`<div class="fs-13" style="color:var(--gold2);font-weight:500;margin-bottom:8px;">${fmt(saldo)} disponível</div>`;
  html+='<div style="display:flex;flex-direction:column;gap:7px;" class="fs-12 text-grey">';
  if(divTot>0) html+=`<div style="padding:7px 9px;background:var(--amber-bg);border-radius:4px;color:var(--amber);">Adiantar parcela de dívida economiza juros de ${S.dividas.sort((a,b)=>b.juros-a.juros)[0]?.juros||0}% a.m.</div>`;
  if(saldo>entradas*3) html+=`<div style="padding:7px 9px;background:var(--green-bg);border-radius:4px;color:var(--green);">Aplique o excedente em Tesouro Selic — rende mais que poupança com liquidez diária.</div>`;
  html+=`<div style="padding:7px 9px;background:var(--gold-bg);border-radius:4px;color:var(--gold2);">Considere reforçar uma meta — ${S.metas[0]?.nome||'você ainda não tem metas cadastradas'}.</div>`;
  html+='</div>';
  el.innerHTML=html;
}

async function sendToIA(){
  const input=document.getElementById('ia-input');
  const msg=input.value.trim();
  if(!msg) return;
  input.value='';
  const chat=document.getElementById('ia-chat');

  // Add user message
  iaHistory.push({role:'user',content:msg});
  chat.innerHTML+=`<div class="ia-msg user">${msg}</div>`;
  chat.innerHTML+=`<div class="ia-loading" id="ia-loader"><div class="ia-dot"></div><div class="ia-dot"></div><div class="ia-dot"></div></div>`;
  chat.scrollTop=chat.scrollHeight;

  // Build context
  const items=S.lancamentos;
  const entradas=items.filter(l=>l.tipo==='entrada').reduce((a,l)=>a+l.valor,0);
  const saidas=items.filter(l=>l.tipo==='saida').reduce((a,l)=>a+l.valor,0);
  const saldo=entradas-saidas;
  const divTot=S.dividas.reduce((a,d)=>a+d.total,0);
  const divParc=S.dividas.reduce((a,d)=>a+d.parcela,0);
  const context=`Você é um consultor financeiro pessoal brasileiro especializado em finanças pessoais para casais. Seja direto, analítico e use dados concretos.

DADOS FINANCEIROS ATUAIS DO CASAL (Diego & Dinha):
- Renda total registrada: ${fmt(entradas)}
- Gastos totais: ${fmt(saidas)} (${entradas>0?((saidas/entradas)*100).toFixed(0):0}% da renda)
- Saldo disponível: ${fmt(saldo)}
- Total em dívidas: ${fmt(divTot)}
- Parcelas mensais: ${fmt(divParc)}
- Investimentos: ${fmt(S.investimentos.reduce((a,i)=>a+i.valor,0))}
- Projetos: Empadas da Dinha (resultado: ${fmt(S.empadas.filter(l=>l.tipo==='receita').reduce((a,l)=>a+l.valor,0)-S.empadas.filter(l=>l.tipo==='custo').reduce((a,l)=>a+l.valor,0))}), Laromme em início
- Dívidas: ${S.dividas.map(d=>`${d.desc}: ${fmt(d.total)} a ${d.juros}%a.m.`).join('; ')||'Nenhuma cadastrada'}
- Metas: ${S.metas.map(m=>`${m.nome}: ${fmt(m.atual)}/${fmt(m.total)}`).join('; ')||'Nenhuma cadastrada'}

Responda em português, de forma estruturada. Seja específico com valores e prazos. Explique sempre o impacto real da decisão no curto, médio e longo prazo. Se a estratégia proposta tiver riscos, proponha uma alternativa melhor com justificativa clara.`;

  try {
    const response=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        model:'claude-sonnet-4-20250514',
        max_tokens:1000,
        system:context,
        messages:iaHistory
      })
    });
    const data=await response.json();
    const reply=data.content?.[0]?.text||'Não foi possível obter resposta.';
    iaHistory.push({role:'assistant',content:reply});
    document.getElementById('ia-loader')?.remove();
    chat.innerHTML+=`<div class="ia-msg assistant">${reply.replace(/\n/g,'<br>')}</div>`;
  } catch(e){
    document.getElementById('ia-loader')?.remove();
    chat.innerHTML+=`<div class="ia-msg assistant">Erro ao conectar com a IA. Verifique sua conexão.</div>`;
  }
  chat.scrollTop=chat.scrollHeight;
}

// ═══════ CONSOLIDADO ═══════
function renderConsolidado(){
  const diego=S.lancamentos.filter(l=>l.owner==='Diego');
  const dinha=S.lancamentos.filter(l=>l.owner==='Dinha');
  const all=S.lancamentos;
  const sum=(arr,tipo)=>arr.filter(l=>l.tipo===tipo).reduce((a,l)=>a+l.valor,0);
  document.getElementById('cas-renda').textContent=fmt(sum(all,'entrada'));
  document.getElementById('cas-gastos').textContent=fmt(sum(all,'saida'));
  document.getElementById('cas-saldo').textContent=fmt(sum(all,'entrada')-sum(all,'saida'));
  document.getElementById('cas-dividas').textContent=fmt(S.dividas.reduce((a,d)=>a+d.total,0));
  const mkSummary=(arr,name)=>{
    const e=sum(arr,'entrada'),s=sum(arr,'saida');
    if(!arr.length) return`<div class="fs-12 text-grey">Nenhum registro de ${name}.</div>`;
    return`<div class="flex-between mb-12"><span class="fs-12 text-grey">Entradas</span><span class="tx-val text-green">${fmt(e)}</span></div><div class="flex-between mb-12"><span class="fs-12 text-grey">Saídas</span><span class="tx-val text-red">${fmt(s)}</span></div><div class="flex-between"><span class="fs-12 text-grey">Saldo</span><span class="tx-val ${e-s>=0?'text-gold':'text-red'}">${fmt(e-s)}</span></div>`;
  };
  document.getElementById('cas-diego').innerHTML=mkSummary(diego,'Diego');
  document.getElementById('cas-dinha').innerHTML=mkSummary(dinha,'Dinha');
  const tbody=document.getElementById('cas-tx-tbody');
  if(!all.length){tbody.innerHTML='<tr><td colspan="6" style="text-align:center;padding:20px;color:var(--grey2);">Nenhum lançamento.</td></tr>';return;}
  tbody.innerHTML=[...all].reverse().map(l=>`<tr><td class="mono">${l.data}</td><td style="color:var(--white);">${l.desc}</td><td>${l.cat}</td><td><span class="badge ${l.tipo==='entrada'?'b-green':'b-red'}">${l.tipo}</span></td><td>${l.owner}</td><td class="mono ${l.tipo==='entrada'?'text-green':'text-red'}">${l.tipo==='entrada'?'+':'-'}${fmt(l.valor)}</td></tr>`).join('');
}

// ═══════ CALENDÁRIO ═══════
let calYear=new Date().getFullYear(),calMonth=new Date().getMonth();
function calNav(d){calMonth+=d;if(calMonth>11){calMonth=0;calYear++;}else if(calMonth<0){calMonth=11;calYear--;}renderCalendario();}
function renderCalendario(){
  const now=new Date();
  document.getElementById('cal-title').textContent=new Date(calYear,calMonth,1).toLocaleDateString('pt-BR',{month:'long',year:'numeric'});
  const firstDay=new Date(calYear,calMonth,1).getDay();
  const daysInMonth=new Date(calYear,calMonth+1,0).getDate();
  const days=['Dom','Seg','Ter','Qua','Qui','Sex','Sáb'];
  let html=days.map(d=>`<div class="cal-header">${d}</div>`).join('');
  for(let i=0;i<firstDay;i++) html+=`<div class="cal-day empty"></div>`;
  const entradas=S.lancamentos;
  for(let d=1;d<=daysInMonth;d++){
    const ds=`${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const dayItems=entradas.filter(l=>l.data===ds);
    const saidas=dayItems.filter(l=>l.tipo==='saida').reduce((a,l)=>a+l.valor,0);
    const renda=entradas.filter(l=>l.tipo==='entrada').reduce((a,l)=>a+l.valor,0)/30;
    const isToday=d===now.getDate()&&calMonth===now.getMonth()&&calYear===now.getFullYear();
    let cls='no-data';
    if(dayItems.length>0){
      if(saidas>renda*1.5) cls='red';
      else if(saidas>renda*0.8) cls='amber';
      else cls='green';
    }
    if(isToday) cls+=cls?' today':' today';
    html+=`<div class="cal-day ${cls}" title="${ds}: ${dayItems.length} lançamentos">${d}</div>`;
  }
  document.getElementById('cal-grid').innerHTML=html;
  // Week chart
  const weekDays=['Dom','Seg','Ter','Qua','Qui','Sex','Sáb'];
  const weekData=[0,0,0,0,0,0,0];
  S.lancamentos.filter(l=>l.tipo==='saida').forEach(l=>{const d=new Date(l.data+'T12:00:00');weekData[d.getDay()]+=l.valor;});
  const maxW=Math.max(...weekData,1);
  document.getElementById('week-chart').innerHTML=weekDays.map((d,i)=>`<div class="bar-col"><div class="bar-col-val">${weekData[i]>0?fmt(weekData[i]).replace('R$\u00a0',''):''}</div><div class="bar-bar" style="height:${(weekData[i]/maxW)*70}px;background:${weekData[i]===Math.max(...weekData)?'var(--red)':'var(--blue)'};"></div><div class="bar-col-label">${d}</div></div>`).join('');
  // Insights
  const maxDia=weekDays[weekData.indexOf(Math.max(...weekData))];
  const totalGastosMes=S.lancamentos.filter(l=>l.tipo==='saida'&&l.data.startsWith(`${calYear}-${String(calMonth+1).padStart(2,'0')}`)).reduce((a,l)=>a+l.valor,0);
  document.getElementById('cal-insights').innerHTML=weekData.some(v=>v>0)?`<div style="display:flex;flex-direction:column;gap:6px;"><div>${maxDia} é o dia com maiores gastos históricos.</div><div>Total de gastos no período: <strong style="color:var(--white);">${fmt(totalGastosMes)}</strong></div></div>`:'Sem dados suficientes para análise.';
}

// ═══════ RELATÓRIO ═══════
function checkFecharMes(){
  const now=new Date();
  const card=document.getElementById('fechar-mes-card');
  const mesRef=new Date(now.getFullYear(),now.getMonth()-1,1);
  document.getElementById('mes-ref').textContent=mesRef.toLocaleDateString('pt-BR',{month:'long',year:'numeric'});
  // Show on day 1 (or always for demo)
  if(now.getDate()===1||true){card.style.display='block';}
}
function renderRelatorio(){
  const items=S.lancamentos;
  const entradas=items.filter(l=>l.tipo==='entrada').reduce((a,l)=>a+l.valor,0);
  const saidas=items.filter(l=>l.tipo==='saida').reduce((a,l)=>a+l.valor,0);
  const cats={};
  items.filter(l=>l.tipo==='saida').forEach(l=>{cats[l.cat]=(cats[l.cat]||0)+l.valor;});
  const sorted=Object.entries(cats).sort((a,b)=>b[1]-a[1]);
  const lim=document.getElementById('rel-limites');
  if(items.length>=5){
    lim.innerHTML=sorted.slice(0,6).map(([cat,val])=>{
      const pct=entradas>0?(val/entradas*100).toFixed(1):0;
      const ideal={'Alimentação':15,'Moradia':25,'Transporte':10,'Lazer':10,'Assinaturas':5};
      const cat2=Object.keys(ideal).find(k=>cat.toLowerCase().includes(k.toLowerCase()));
      const lim2=ideal[cat2]||10;
      const cls=pct>lim2*1.5?'fill-red':pct>lim2?'fill-amber':'fill-green';
      return`<div class="prog-wrap"><div class="prog-header"><span>${cat}</span><span class="prog-pct">${pct}% da renda</span></div><div class="prog-bar"><div class="prog-fill ${cls}" style="width:${Math.min(pct*2,100)}%"></div></div><div class="fs-11 text-grey" style="margin-top:3px;">${fmt(val)} · Limite sugerido: ${lim2}% (${fmt(entradas*lim2/100)})</div></div>`;
    }).join('');
  }
  const ind=document.getElementById('rel-indicadores');
  ind.innerHTML=`<div class="flex-between mb-12"><span class="fs-12 text-grey">Taxa de gastos</span><span class="mono ${saidas/entradas>0.8?'text-red':'text-green'}">${entradas>0?((saidas/entradas)*100).toFixed(1):0}%</span></div><div class="flex-between mb-12"><span class="fs-12 text-grey">Capacidade de investir</span><span class="mono text-gold">${fmt(Math.max(entradas-saidas,0))}</span></div><div class="flex-between mb-12"><span class="fs-12 text-grey">Total em dívidas</span><span class="mono text-red">${fmt(S.dividas.reduce((a,d)=>a+d.total,0))}</span></div><div class="flex-between"><span class="fs-12 text-grey">Total investido</span><span class="mono text-gold">${fmt(S.investimentos.reduce((a,i)=>a+i.valor,0))}</span></div>`;
}
async function fecharMes(){
  document.getElementById('btn-fechar-mes').textContent='Gerando...';
  document.getElementById('btn-fechar-mes').disabled=true;
  // Reveal report buttons
  document.getElementById('rel-buttons').style.display='flex';
  renderRelatorio();
  document.getElementById('btn-fechar-mes').textContent='Mês Fechado';
  showToast('Mês fechado. Baixe o relatório.');
}
async function baixarRelatorio(){
  const items=S.lancamentos;
  const entradas=items.filter(l=>l.tipo==='entrada').reduce((a,l)=>a+l.valor,0);
  const saidas=items.filter(l=>l.tipo==='saida').reduce((a,l)=>a+l.valor,0);
  const saldo=entradas-saidas;
  const divTot=S.dividas.reduce((a,d)=>a+d.total,0);
  showToast('Gerando relatório com IA...');

  let relText='Relatório em geração...';
  try{
    const res=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        model:'claude-sonnet-4-20250514',
        max_tokens:1000,
        messages:[{role:'user',content:`Você é um consultor financeiro. Gere um relatório mensal completo e profissional para o casal Diego e Dinha com os seguintes dados:

- Renda total: ${fmt(entradas)}
- Gastos totais: ${fmt(saidas)} (${entradas>0?((saidas/entradas)*100).toFixed(1):0}% da renda)
- Saldo: ${fmt(saldo)}
- Dívidas: ${fmt(divTot)}
- Investimentos: ${fmt(S.investimentos.reduce((a,i)=>a+i.valor,0))}
- Projetos: Empadas (${fmt(S.empadas.filter(l=>l.tipo==='receita').reduce((a,l)=>a+l.valor,0)-S.empadas.filter(l=>l.tipo==='custo').reduce((a,l)=>a+l.valor,0))}), Laromme em início
- Lançamentos: ${items.length} registros

Estruture o relatório com: 1) Resumo executivo do mês, 2) Pontos positivos, 3) Oportunidades de melhoria, 4) Análise de evolução, 5) Indicadores de atenção, 6) Plano de ação para o próximo mês com 3 prioridades objetivas. Seja específico e use os valores reais.`}]
      })
    });
    const data=await res.json();
    relText=data.content?.[0]?.text||'Erro ao gerar.';
  }catch(e){relText='Não foi possível conectar com a IA. Verifique sua conexão.';}

  // Print PDF
  const win=window.open('','_blank');
  win.document.write(`<!DOCTYPE html><html><head><title>Relatório Mensal — Diego & Dinha</title><style>body{font-family:Georgia,serif;max-width:800px;margin:40px auto;color:#222;line-height:1.8;}h1{color:#b8973a;font-size:24px;}pre{white-space:pre-wrap;font-family:Georgia,serif;}</style></head><body><h1>Relatório Mensal — Diego & Dinha</h1><p><strong>Gerado em:</strong> ${new Date().toLocaleDateString('pt-BR')}</p><hr><pre>${relText}</pre></body></html>`);
  win.document.close();
  setTimeout(()=>win.print(),800);
  document.getElementById('btn-baixar-rel').textContent='Relatório Baixado';
  document.getElementById('btn-baixar-rel').disabled=true;
  showToast('Relatório gerado com sucesso!');
}

// ═══════ EXPORT ═══════
function exportCSV(){
  const rows=[['Data','Descrição','Categoria','Tipo','Titular','Valor'],...S.lancamentos.map(l=>[l.data,l.desc,l.cat,l.tipo,l.owner,l.valor])];
  const csv=rows.map(r=>r.join(',')).join('\n');
  const a=document.createElement('a');a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv);a.download='patrimonio-casal.csv';a.click();
  showToast('CSV exportado.');
}
function exportPDFConsolidado(){
  const win=window.open('','_blank');
  const all=S.lancamentos;
  const e=all.filter(l=>l.tipo==='entrada').reduce((a,l)=>a+l.valor,0);
  const s=all.filter(l=>l.tipo==='saida').reduce((a,l)=>a+l.valor,0);
  win.document.write(`<!DOCTYPE html><html><head><title>Consolidado Casal</title><style>body{font-family:Georgia,serif;max-width:800px;margin:40px auto;color:#222;}table{width:100%;border-collapse:collapse;}th,td{padding:8px;border:1px solid #ddd;text-align:left;}th{background:#f5f0e8;}</style></head><body><h1>Visão Consolidada — Diego & Dinha</h1><p>Gerado em ${new Date().toLocaleDateString('pt-BR')}</p><h3>Resumo</h3><p>Renda Total: <strong>R$ ${e.toFixed(2)}</strong> | Gastos: <strong>R$ ${s.toFixed(2)}</strong> | Saldo: <strong>R$ ${(e-s).toFixed(2)}</strong></p><h3>Lançamentos</h3><table><thead><tr><th>Data</th><th>Descrição</th><th>Categoria</th><th>Tipo</th><th>Titular</th><th>Valor</th></tr></thead><tbody>${all.map(l=>`<tr><td>${l.data}</td><td>${l.desc}</td><td>${l.cat}</td><td>${l.tipo}</td><td>${l.owner}</td><td>${l.tipo==='entrada'?'+':'-'}R$${l.valor.toFixed(2)}</td></tr>`).join('')}</tbody></table></body></html>`);
  win.document.close();setTimeout(()=>win.print(),600);
}

// ═══════ RENDER ALL ═══════
function renderAll(){
  renderLancamentos();renderDividas();renderMetas();renderBanks();renderEmpadas();renderLaromme();renderInv();renderRecorrentes();checkAlertas();
}

// ═══════ INIT ═══════
setLancTipo('entrada');
setLarTipo('investimento');
buildTree('emp-cat-tree','emp-cat-crumb','emp-cat',CAT_EMP_C,[]);
setDate();
renderAll();
updateDashboard();
</script>
</body>
</html>
